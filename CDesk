#!/usr/bin/env python3
import os
import argparse
import sys
import subprocess
import json
import shutil
import pathlib

print('——————————————————————————————Load CDesk environment——————————————————————————————')
root_dir = os.path.dirname(os.path.realpath(__file__))
config_path = os.path.join(root_dir, 'config.json')
with open(config_path, "r") as f:
    config = json.load(f)

# Extract conda envs
conda_envs = {}
try:
    out = subprocess.check_output(
        ["conda", "env", "list", "--json"],
        stderr=subprocess.DEVNULL,
        text=True       
    )
    envs = json.loads(out)["envs"]
    conda_env_names = [pathlib.Path(p).name for p in envs]
    conda_envs = {k: v for k, v in zip(conda_env_names, envs)}
except Exception as e:
    print('Fail to load conda environment')

# Extract mamba envs
mamba_envs = {}
try:
    out = subprocess.check_output(
        ["mamba", "env", "list", "--json"],
        stderr=subprocess.DEVNULL,
        text=True       
    )
    envs = json.loads(out)["envs"]
    mamba_env_names = [pathlib.Path(p).name for p in envs]
    mamba_envs = {k: v for k, v in zip(mamba_env_names, envs)}
except Exception as e:
    print('Fail to load mamba environment')

CDesk_envs = {}
CDesk_env = os.environ.copy()
# CDesk,CDesk_R,CDesk_py3.7,CDesk_py2.7
CDesk_env['python3_7'] = 'python';CDesk_env['python3_6']='python'
for env in ['CDesk','CDesk_py3.7','CDesk_py2.7','CDesk_R']:
    if env in list(conda_envs.keys()):
        CDesk_envs[env] = os.path.join(conda_envs[env],'bin')
        CDesk_env[env] = os.path.join(conda_envs[env],'bin')
        if env == 'CDesk':
            CDesk_env['python3_6'] ='python3.6'
        if env == 'CDesk_py3.7':
            CDesk_env['python3_7'] ='python3.7'
        print(f'Load {env} from conda environment: {conda_envs[env]}')
    elif env in list(mamba_envs.keys()):
        CDesk_envs[env] = os.path.join(mamba_envs[env],'bin')
        CDesk_env[env] = os.path.join(mamba_envs[env],'bin')
        if env == 'CDesk':
            CDesk_env['python3_6'] ='python3.6'
        if env == 'CDesk_py3.7':
            CDesk_env['python3_7'] ='python3.7'
        print(f'Load {env} from mamba environment: {mamba_envs[env]}')
    elif os.path.exists(os.path.join(config['conda_env'][env])):
        CDesk_envs[env] = os.path.join(config['conda_env'][env],'bin')
        CDesk_env[env] = os.path.join(config['conda_env'][env],'bin')
        print(f"Load {env} from {config_path}: {config['conda_env'][env]}")
        if env == 'CDesk':
            CDesk_env['python3_6'] ='python3.6'
        if env == 'CDesk_py3.7':
            CDesk_env['python3_7'] ='python3.7'
    else:
        CDesk_envs[env] = ''
        CDesk_env[env] = ''
        print(f'Fail to load {env} environment, use the default environment')

extra_path = os.pathsep.join(CDesk_envs[env] for env in ['CDesk_R','CDesk','CDesk_py3.7','CDesk_py2.7'] if CDesk_envs[env])

CDesk_env["CDesk_config"] = config_path

if extra_path:
    CDesk_env['PATH'] = extra_path + os.pathsep + CDesk_env['PATH']

print('——————————————————————————————CDesk environment ready——————————————————————————————')

# tools 1. Download
def tools_download(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/');args.key = args.key.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output);args.key = args.key.rstrip('/')
    bash_script = os.path.join(root_dir,'0.Tools','1.Download','Download_ERR_SRR.sh')
    cmd = [bash_script,'-i',args.input,'-o',args.output,'-p',str(args.thread),'-k',args.key]
    subprocess.run(cmd,check=True,env=CDesk_env)

# tools 2. Prepare
def tools_prepare(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    python_script = os.path.join(root_dir,'0.Tools','2.Prepare','prepare.py')
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-o',args.output,'--pair',args.pair,'--single',args.single]
    subprocess.run(cmd,check=True,env=CDesk_env)

# bulkRNA 1. Preprocess
def bulkRNA_preprocess(args): 
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)

    python_script = os.path.join(root_dir,'1.RNAseq','1.Preprocess','data.py')
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-o',args.output]
    subprocess.run(cmd,check=True,env=CDesk_env)

    bash_script = os.path.join(root_dir,'1.RNAseq','1.Preprocess','BulkRNAseqData.sh')
    cmd = [bash_script,'-s', args.species, '-i', os.path.join(args.output,'data'), '-o', args.output, '-p', str(args.thread)]
    subprocess.run(cmd,check=True,env=CDesk_env)

    if args.bw:
        bash_script = os.path.join(root_dir,'1.RNAseq','1.Preprocess','BulkRNAseqBW.sh')
        cmd = [bash_script, '-i', f"{args.output}/Bam", '-o', f"{args.output}/BW", '-p', str(args.thread)]
        subprocess.run(cmd, check=True,env=CDesk_env)

    if args.te:
        bash_script = os.path.join(root_dir,'1.RNAseq','1.Preprocess','BulkRNAseqTE.sh')
        cmd = [bash_script, '-i', f"{args.output}/Bam", '-o', f"{args.output}/TE", '-p', str(args.thread),'-s',args.species]
        subprocess.run(cmd, check=True,env=CDesk_env)

# bulkRNA 2. cor
def bulkRNA_cor(args):
    R_script = os.path.join(root_dir,'1.RNAseq','2.correlation','cor.R')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/');args.group = args.group.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output);args.group = os.path.abspath(args.group)
    cmd = ['Rscript', R_script,args.input,args.output,args.group,str(args.batch),str(args.width),str(args.height)]
    subprocess.run(cmd, check=True,env=CDesk_env)

# bulkRNA 3. DEG
def bulkRNA_DEG(args):
    python_script = os.path.join(root_dir,'1.RNAseq','3.DEGD','gfold.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    if args.DEG_mode != 'gfold':
        args.group = args.group.rstrip('/');args.group = os.path.abspath(args.group)
        R_script = os.path.join(root_dir,'1.RNAseq','3.DEGD','degd.R')
        cmd = [
            'Rscript', R_script,args.DEG_mode,
            args.input, args.output,args.group,str(args.p),args.gene,str(args.fc),
            str(args.pval),str(args.top_num),str(args.width),str(args.height)
        ]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.DEG_mode == 'gfold':
        cmd = [
                CDesk_env['python3_7'], python_script,
                "--species",args.species,"--output_dir",args.output,
                "--meta_file",args.input,"--top_genes",str(args.top_num),
                "--gene_of_interest",args.gene,"--fc_threshold",str(args.gfold),
                "--thread",str(args.thread),"--width",str(args.width),"--height",str(args.height)
        ]
        if args.p:
            cmd = cmd + ['--plot']
        subprocess.run(cmd, check=True,env=CDesk_env)

# bulkRNA 4. enrich analysis
def bulkRNA_enrich(args):
    if args.enrich_mode == 'analyze':
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
        R_script = os.path.join(root_dir,'1.RNAseq','4.enrich','enrichment_analysis.R')
        if args.type == 'multi':
            R_script = os.path.join(root_dir,'1.RNAseq','4.enrich','enrichment_multi.R')
        if args.species == 'no' and args.custom == 'no':
            print('At least provide species or custom file!')
            sys.exit(1)
        if args.custom != 'no':
            args.custom = args.custom.rstrip('/');args.custom = os.path.abspath(args.custom)
        cmd = ["Rscript", R_script,args.input,args.custom,args.species,args.output,str(args.width),str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.enrich_mode == 'plot':
        R_script = os.path.join(root_dir,'1.RNAseq','4.enrich','enrichment_plot.R')
        if args.type == 'multi':
            R_script = os.path.join(root_dir,'1.RNAseq','4.enrich','enrichment_multi_plot.R')
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
        cmd = ["Rscript", R_script, args.input,args.output,str(args.width),str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.enrich_mode == 'GSEA': 
        R_script = os.path.join(root_dir,'1.RNAseq','4.enrich','gsea.R')
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
        cmd = ['Rscript',R_script,args.input,args.path,args.species,args.cols,args.output,str(args.width),str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)

# bulkRNA 5. Similarity Analysis
def bulkRNA_Similarity(args):
    R_script = os.path.join(root_dir,'1.RNAseq','5.SimilarityAnalysis','Similarity.R')
    args.output = args.output.rstrip('/');args.input = args.input.rstrip('/');args.group = args.group.rstrip('/')
    args.output = os.path.abspath(args.output);args.input = os.path.abspath(args.input);args.group = os.path.abspath(args.group)
    cmd = ['Rscript',R_script,args.input,args.group,args.output,args.gene,args.batch,str(args.width),str(args.height)]
    subprocess.run(cmd, check=True,env=CDesk_env)

# bulkRNA: 6. Clustering
def bulkRNA_Clustering(args):
    if args.cluster_mode == 'WGCNA':
        R_script = os.path.join(root_dir,'1.RNAseq','6.Clustering','WGCNA.R')
        args.output = args.output.rstrip('/');args.input = args.input.rstrip('/');args.pheno = args.pheno.rstrip('/')
        args.output = os.path.abspath(args.output);args.input = os.path.abspath(args.input);args.pheno = os.path.abspath(args.pheno)
        cmd = ['Rscript', R_script,args.input,args.pheno,args.trait,args.output]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.cluster_mode == 'kmean':
        R_script = os.path.join(root_dir,'1.RNAseq','6.Clustering','Kmeans.R')
        args.output = args.output.rstrip('/'); args.input = args.input.rstrip('/');args.group = args.group.rstrip('/')
        args.output = os.path.abspath(args.output);args.input = os.path.abspath(args.input);args.group = os.path.abspath(args.group)
        if args.gene != 'no':
            args.gene = args.gene.rstrip('/');args.gene = os.path.abspath(args.gene)
        cmd = ['Rscript', R_script,args.input,args.group,args.output,str(args.cluster),args.method,
               str(args.height),str(args.width),args.gene]
        subprocess.run(cmd, check=True,env=CDesk_env)

# bulkRNA 7. AlternativeSplicingDetection
def bulkRNA_AlternativeSpliceDetection(args):
    args.output = args.output.rstrip('/');args.b1 = args.b1.rstrip('/')
    args.output = os.path.abspath(args.output);args.b1 = os.path.abspath(args.b1)
    if args.b2 != 'No':
        args.b2 = args.b2.rstrip('/');args.b2 = os.path.abspath(args.b2)
    if args.Splice_mode == 'detect':
        python_script = os.path.join(root_dir,'1.RNAseq','7.AlternativeSplicingDetection','alternative_splicing.py')
        cmd = [CDesk_env['python3_6'], python_script,'--b1',args.b1,'--b2',args.b2,'-s',args.species,'-o',args.output,
                "--type",args.type,"-t",str(args.thread),'--length',str(args.length),
                '--variable_read_length',str(args.variable_read_length),'--allow_clipping',str(args.allow_clipping)]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.Splice_mode == 'draw':
        python_script = os.path.join(root_dir,'1.RNAseq','7.AlternativeSplicingDetection','draw_sashimiplot.py')
        cmd = [CDesk_env['python3_7'], python_script,'--b1',args.b1,'--b2',args.b2,'-s',args.species,'-o',args.output,
                "--region",args.region,"--group",args.group,'--l1',args.l1,'--l2',args.l2,
                '--exon_s',str(args.exon_s),'--intron_s',str(args.intron_s)]
        subprocess.run(cmd,check=True,env=CDesk_env)

# scRNA 1. preprocess
def scRNA_preprocess(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    
    python_script = os.path.join(root_dir,'2.scRNA','1.preprocess','preprocess.py')    
    if args.scRNA_preprocess_mode != 'smartseq':
        cmd = [CDesk_env['python3_7'], python_script,args.scRNA_preprocess_mode,'-i',args.input,'-o',args.output,'-s',args.species,'-t',str(args.thread)]
        if args.scRNA_preprocess_mode == 'cellranger':
            cmd += ['--chemistry',args.chemistry]
        if args.scRNA_preprocess_mode == 'drseq':
            cmd += ['--umi',args.umi,'--barcode',args.barcode]
        subprocess.run(cmd,check=True,env=CDesk_env)

    elif args.scRNA_preprocess_mode == 'smartseq':
        python_script = os.path.join(root_dir,'1.RNAseq','1.Preprocess','data.py')
        cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-o',args.output]
        subprocess.run(cmd,check=True,env=CDesk_env)

        bash_script = os.path.join(root_dir,'1.RNAseq','1.Preprocess','BulkRNAseqData.sh')
        cmd = [bash_script,'-s', args.species, '-i', os.path.join(args.output,'data'), '-o', args.output, '-p', str(args.thread)]
        subprocess.run(cmd,check=True,env=CDesk_env)

        if args.bw:
            bash_script = os.path.join(root_dir,'1.RNAseq','1.Preprocess','BulkRNAseqBW.sh')
            cmd = [bash_script, '-i', f"{args.output}/Bam", '-o', f"{args.output}/BW", '-p', str(args.thread)]
            subprocess.run(cmd, check=True,env=CDesk_env)

        if args.te:
            bash_script = os.path.join(root_dir,'1.RNAseq','1.Preprocess','BulkRNAseqTE.sh')
            cmd = [bash_script, '-i', f"{args.output}/Bam", '-o', f"{args.output}/TE", '-p', str(args.thread),'-s',args.species]
            subprocess.run(cmd, check=True,env=CDesk_env)

# scRNA 2. cluster
def scRNA_cluster(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    python_script = os.path.join(root_dir,'2.scRNA','2.clustering','clustering.py')
    R_script = os.path.join(root_dir,'2.scRNA','2.clustering','clustering.R')
    if args.mode == 'scanpy':
        cmd = [
        CDesk_env['python3_7'], python_script,
        '-i', args.input,
        '-o', args.output,
        '-n', args.name,
        '--min_cells', str(args.min_cells),
        '--min_features', str(args.min_features),
        '--nFeature_RNA_min', str(args.nFeature_RNA_min),
        '--nFeature_RNA_max', str(args.nFeature_RNA_max),
        '--mt_percent', str(args.mt_percent),
        '--variable_features', str(args.variable_features),
        '--dim_prefer', str(args.dim_prefer),
        '--res', str(args.res),
        '--width',str(args.width),
        '--height',str(args.height)
        ]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.mode == 'seurat':
        cmd = [
        'Rscript', R_script,
        args.input,
        args.output,
        args.name,
        str(args.min_cells),
        str(args.min_features),
        str(args.nFeature_RNA_min),
        str(args.nFeature_RNA_max),
        str(args.mt_percent),
        str(args.variable_features),
        str(args.dim_prefer),
        str(args.res),str(args.width),str(args.height)
        ]
        subprocess.run(cmd, check=True,env=CDesk_env)

# scRNA: 3. Annotation
def scRNA_annotation(args):
    R_script = os.path.join(root_dir,'2.scRNA','3.annotation','scRNAseqAnno.R')
    if args.scRNA_annotation_mode == 'marker':
        cmd = ['Rscript',R_script,'marker',args.input,args.marker,args.meta,args.output,str(args.expression_thre),
               str(args.percentage_thre),str(args.marker_thre),args.cluster,str(args.width),str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.scRNA_annotation_mode == 'transfer':
        cmd = ['Rscript',R_script,'transfer',args.ref,args.query,args.meta,args.output,args.cluster,
               str(args.nfeatures),str(args.dims),str(args.width),str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)

# scRNA 4. marker
def scRNA_marker(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    if args.scRNA_marker_mode == 'all':
        R_script = os.path.join(root_dir,'2.scRNA','4.marker','findAllMarkers.R')
        cmd = [
            "Rscript", R_script,
            args.input, args.meta,str(args.fc), str(args.p),str(args.m), args.output,str(args.width),str(args.height)
        ]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.scRNA_marker_mode == '2group':
        R_script = os.path.join(root_dir,'2.scRNA','4.marker','marker_in_2_group.R')
        cmd = [
            "Rscript", R_script,
            '-i',args.input,'-g',args.meta ,'-t',args.type1,'-e',args.type2,
            '-f',str(args.fc), '--adjPvalFilter',str(args.p),'-m',str(args.m),'-o',args.output,
            '--width',str(args.width),'--height',str(args.height)
        ]
        subprocess.run(cmd, check=True,env=CDesk_env)

# scRNA: 5. trajectory
def scRNA_trajectory(args):
    if args.scRNA_trajectory_mode == 'monocle':
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
        R_script = os.path.join(root_dir,'2.scRNA','5.trajectory','monocle3.R')
        cmd = ['Rscript',R_script,args.input,args.output,args.meta,args.start,str(args.width),str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.scRNA_trajectory_mode == 'diffusion':
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
        R_script = os.path.join(root_dir,'2.scRNA','5.trajectory','diffusionmap.R')
        cmd = ['Rscript',R_script,args.input,args.output,args.meta,args.start,str(args.width),str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.scRNA_trajectory_mode == 'velocity':
        args.cellranger = args.cellranger.rstrip('/');args.output = args.output.rstrip('/');args.rds = args.rds.rstrip('/');args.genes = args.genes.rstrip('/')
        args.cellranger = os.path.abspath(args.cellranger);args.output = os.path.abspath(args.output);args.rds = os.path.abspath(args.rds);args.genes = os.path.abspath(args.genes) 
        python_script = os.path.join(root_dir,'2.scRNA','5.trajectory','velocity.py')
        cmd = [CDesk_env['python3_7'],python_script,'--cellranger_output',args.cellranger,
               '--rds_file',args.rds,'--gtf',args.gtf,'--genes',args.genes,'-o',args.output,
               '--meta',args.meta,'--width',str(args.width),'--height',str(args.height),'-t',str(args.thread)]
        subprocess.run(cmd, check=True,env=CDesk_env)
        figures_dir = os.path.join(os.getcwd(),'figures')
        if os.path.exists(figures_dir) and os.path.isdir(figures_dir):
            shutil.rmtree(figures_dir)
    elif args.scRNA_trajectory_mode == 'cstreet':
        args.expression = args.expression.rstrip('/');args.output = args.output.rstrip('/');args.state = args.state.rstrip('/')
        args.expression = os.path.abspath(args.expression);args.output = os.path.abspath(args.output);args.state = os.path.abspath(args.state)
        python_script = os.path.join(root_dir,'2.scRNA','5.trajectory','cstreet.py')
        cmd = [CDesk_env['python3_7'],python_script,'-i',args.expression,'-s',args.state,'-n',args.name,'-o',args.output]
        subprocess.run(cmd, check=True,env=CDesk_env)

# scRNA: 6. similarity
def scRNA_similarity(args):
    args.output = args.output.rstrip('/');args.sample1 = args.sample1.rstrip('/');args.sample2 = args.sample2.rstrip('/');args.type1 = args.type1.rstrip('/');args.type2 = args.type2.rstrip('/')
    args.output = os.path.abspath(args.output);args.sample1 = os.path.abspath(args.sample1);args.sample2 = os.path.abspath(args.sample2);args.type1 = os.path.abspath(args.type1);args.type2 = os.path.abspath(args.type2)
    R_script = os.path.join(root_dir,'2.scRNA','6.similarity','correlation.R')
    cmd = ['Rscript',R_script,args.sample1,args.sample2,args.meta1,args.meta2,args.type1,args.type2,args.output,str(args.nfeatures_used),str(args.integrate_features),str(args.width),str(args.height)]
    subprocess.run(cmd, check=True,env=CDesk_env)

# scRNA: 7. interaction
def scRNA_interaction(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    if args.scRNA_interaction_mode == 'cellchat':
        R_script = os.path.join(root_dir,'2.scRNA','7.interaction','cellchat.R')
        cmd = ['Rscript',R_script,'--seurat_file',args.input,"--output_directory",args.output,"--threads",str(args.thread),"--species",args.species,"--group_by",args.group,"--width",str(args.width),"--height",str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.scRNA_interaction_mode == 'pyscenic':
        args.tf = args.tf.rstrip('/');args.db = args.db.rstrip('/')
        args.tf = os.path.abspath(args.tf);args.db = os.path.abspath(args.db)
        python_script = os.path.join(root_dir,'2.scRNA','7.interaction','GRN.py')
        cmd = [CDesk_env['python3_7'],python_script,'-i',args.input,'-o',args.output,"--tf-list",args.tf,"--db-folder",args.db,"--species",args.species,"--num-workers",str(args.thread),"--auc-threshold",str(args.auc),"--nes-threshold",str(args.nes),'--normalize',str(args.normalize),'--scale',str(args.scale),'--log',str(args.log),'--top_regulons',str(args.top_regulons),'--top_targets',str(args.top_targets),'--plot_tf',str(args.plot_tf)]
        subprocess.run(cmd, check=True,env=CDesk_env)

# scRNA: 8. integrate
def scRNA_integrate(args):
    if args.scRNA_integrate_mode == 'seurat':
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
        R_script = os.path.join(root_dir,'2.scRNA','8.integrate','integrate.R')
        cmd = ['Rscript',R_script,args.input,args.mode,args.output,str(args.min_cells),str(args.min_features),str(args.nfeatures_used),
               str(args.integrate_features),str(args.pc_num),str(args.pc_reduce),str(args.max_iter_harmony),str(args.k_anchor),str(args.width),str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)
    elif args.scRNA_integrate_mode == 'bulk':
        args.meta = args.meta.rstrip('/');args.output = args.output.rstrip('/');args.bulk = args.bulk.rstrip('/');args.scRNA = args.scRNA.rstrip('/')
        args.meta = os.path.abspath(args.meta);args.output = os.path.abspath(args.output);args.bulk = os.path.abspath(args.bulk);args.scRNA = os.path.abspath(args.scRNA)
        R_script = os.path.join(root_dir,'2.scRNA','8.integrate','bulk+scRNA.R')
        cmd = ['Rscript',R_script,args.bulk,args.scRNA,args.meta,args.output,str(args.nfeatures_used),
               str(args.integrate_features),str(args.pc_num),str(args.pc_reduce),str(args.width),str(args.height)]
        subprocess.run(cmd, check=True,env=CDesk_env)

# ATAC 1. preprocess
def ATAC_preprocess(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)

    python_script = os.path.join(root_dir,'3.ATAC','1.preprocess','data.py')
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-o',args.output]
    subprocess.run(cmd,check=True,env=CDesk_env)

    bash_script = os.path.join(root_dir,'3.ATAC','1.preprocess','ATACseqData.sh')
    cmd = [bash_script,'-i',os.path.join(args.output,'data'),'-o',args.output,'-s',args.species,'-p',str(args.thread),'-g',args.input]
    subprocess.run(cmd,check=True,env=CDesk_env)

# ATAC: 2. QC
def ATAC_cor(args):
    python_script = os.path.join(root_dir,'3.ATAC','2.correlation','cor.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'--species',args.species,'--bin',str(args.bin),
           '--step',str(args.step),'-o',args.output,'-t',str(args.thread),'--width',str(args.width),'--height',str(args.height)]
    subprocess.run(cmd,check=True,env=CDesk_env)

# ATAC: 3. Dynamic
def ATAC_dynamic(args):
    python_script = os.path.join(root_dir,'3.ATAC','3.dynamic','dynamic.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    cmd = [CDesk_env['python3_7'], python_script,'--file_meta',args.input,
           '--remove_cluster',args.remove_cluster,'--important_index',str(args.important_index),
           '--species',args.species,'-o',args.output]
    subprocess.run(cmd,check=True,env=CDesk_env)

# ATAC 4. motif
def ATAC_motif(args):
    if args.motif_mode =='homer':
        python_script = os.path.join(root_dir,'3.ATAC','4.motif','FindMotif_homer.py')
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
        cmd = [CDesk_env['python3_7'], python_script,args.input,args.output,args.species,str(args.thread),args.mode,str(args.start),str(args.end)]
        subprocess.run(cmd,check=True,env=CDesk_env)
    elif args.motif_mode =='meme':
        python_script = os.path.join(root_dir,'3.ATAC','4.motif','FindMotif_meme.py')
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/');args.database=args.database.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output);args.database=os.path.abspath(args.database)
        cmd = [CDesk_env['python3_7'], python_script,args.input,args.database,args.output,str(args.thread),str(args.nmotifs)]
        subprocess.run(cmd,check=True,env=CDesk_env)
    elif args.motif_mode =='homer_heatmap':
        R_script = os.path.join(root_dir,'3.ATAC','4.motif','homer_heatmap.R')
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
        if args.motif != 'no':
            args.motif = args.motif.rstrip('/');args.motif = os.path.abspath(args.motif)
        cmd = ["Rscript",R_script,args.input,args.output,args.motif,str(args.width),str(args.height)]
        subprocess.run(cmd,check=True,env=CDesk_env)
    elif args.motif_mode =='enrich_heatmap':
        python_script = os.path.join(root_dir,'3.ATAC','4.motif','motif_enrich_heatmap.py')
        args.motif_bed = args.motif_bed.rstrip('/');args.output = args.output.rstrip('/');args.bed = args.bed.rstrip('/')
        args.motif_bed = os.path.abspath(args.motif_bed);args.output = os.path.abspath(args.output);args.bed = os.path.abspath(args.bed)
        cmd = [CDesk_env['python3_7'], python_script,'--motif_bed',args.motif_bed,'-o',args.output,'--bed',args.bed,
               '--species',args.species,"-t",str(args.thread)]
        subprocess.run(cmd,check=True,env=CDesk_env)

# ATAC: 5. Accessbility
def ATAC_accessbility(args):
    python_script = os.path.join(root_dir,'3.ATAC','5.accessbility','accessbility.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/');args.bw=args.bw.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output);args.bw = os.path.abspath(args.bw)
    if args.region_list != '':
        args.region_list = args.region_list.rstrip('/');args.region_list = os.path.abspath(args.region_list)
    if args.mode == 'gene':
        if args.species == None:
            print("Please provide gene parameter for gene mode")
            sys.exit(1)
        cmd = [CDesk_env['python3_7'], python_script,'-bw',args.bw,'-o',args.output,'-m',args.mode,
               '-i',args.input,'-s',args.species,'--promoter_size',str(args.promoter_size),
               '--method',args.method,'--region_list',args.region_list,'--center',args.center]
    else:
        cmd = [CDesk_env['python3_7'], python_script,'-bw',args.bw,'-o',args.output,'-m',args.mode,
               '-i',args.input,'--promoter_size',str(args.promoter_size),
               '--method',args.method,'--region_list',args.region_list,'--center',args.center]
    subprocess.run(cmd,check=True,env=CDesk_env)

# ATAC: 6. IGV snapshots
def ATAC_igv(args):
    python_script = os.path.join(root_dir,'3.ATAC','6.igv','snapshot.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/');args.region=args.region.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output);args.region=os.path.abspath(args.region)
    cmd = [CDesk_env['python3_6'], python_script,'-i',args.input,'-o',args.output,'--genome',args.genome,
               '--display_mode',args.display_mode,'--region',args.region,
               '--type',args.type]
    subprocess.run(cmd,check=True,env=CDesk_env)

# ATAC: 7. Similarity
def ATAC_similarity(args):
    bash_script = os.path.join(root_dir,'3.ATAC','7.similarity','ATAC_data_correlation.sh')
    args.bw1 = args.bw1.rstrip('/');args.output = args.output.rstrip('/');args.bw2 = args.bw2.rstrip('/')
    args.bw1 = os.path.abspath(args.bw1);args.output = os.path.abspath(args.output);args.bw2 = os.path.abspath(args.bw2)
    if args.region:
        args.region = args.region.rstrip('/');args.region = os.path.abspath(args.region)
        cmd = [bash_script,args.bw1,args.bw2,
            args.output,str(args.thread),args.region]
    else:
        cmd = [bash_script,args.bw1,args.bw2,
            args.output,str(args.thread)]
    subprocess.run(cmd,check=True,env=CDesk_env)

# ChIPseq&CUTTag: 1. Preprocess
def ChIPseq_CUTTag_preprocess(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)

    python_script = os.path.join(root_dir,'4.ChIPseqCUTTag','1.preprocess','data.py')
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-o',args.output]
    subprocess.run(cmd,check=True,env=CDesk_env)

    bash_script = os.path.join(root_dir,'4.ChIPseqCUTTag','1.preprocess','ChIPseqCUTTagData.sh')
    cmd = [bash_script,'-i',os.path.join(args.output,'data'),'-o',args.output,'-s',args.species,'-p',str(args.thread),'-g',args.input]
    subprocess.run(cmd,check=True,env=CDesk_env)

# ChIPseq&CUTTag: 3. Pattern
def ChIPseq_CUTTag_pattern(args):
    python_script = os.path.join(root_dir,'4.ChIPseqCUTTag','3.pattern','pattern.py')
    args.bw = args.bw.rstrip('/');args.output = args.output.rstrip('/');args.bed=args.bed.rstrip('/')
    args.bw = os.path.abspath(args.bw);args.output = os.path.abspath(args.output);args.bed=os.path.abspath(args.bed)
    cmd = [CDesk_env['python3_6'], python_script,'-bw',args.bw,'-bed',args.bed,'-o',args.output,
           '--mode',args.mode,'--region',args.region,
            '--height',str(args.height),'-a',str(args.upstream),'-b',str(args.downstream),'-m',str(args.length)]
    subprocess.run(cmd,check=True,env=CDesk_env)

# HiC: 1. preprocess
def HiC_preprocess(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)

    python_script = os.path.join(root_dir,'5.HiC','1.Preprocess','data.py')
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-o',args.output]
    subprocess.run(cmd,check=True,env=CDesk_env)

    bash_script = os.path.join(root_dir,'5.HiC','1.Preprocess','HiCData.sh')
    cmd = [bash_script,'-i',os.path.join(args.output,'data'),'-o',args.output,'-s',args.species,'-t',str(args.thread),'-f',str(args.filter),'-r',args.resolution]
    subprocess.run(cmd,check=True,env=CDesk_env)

# HiC: 2. Correlation
def HiC_cor(args):
    python_script = os.path.join(root_dir,'5.HiC','2.Correlation','correlation.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-o',args.output,'--chr',args.chr,
            '--inter_chrom',str(args.inter_chrom),'--width',str(args.width),'--height',str(args.height)]
    subprocess.run(cmd,check=True,env=CDesk_env)

# HiC: 3. Matrix
def HiC_matrix(args):
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    python_script = os.path.join(root_dir,'5.HiC','3.Matrix','matrix.py')
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-o',args.output,'--inputFormat',args.inputFormat,
               '--outputFormat',args.outputFormat,'-t',str(args.thread),'-n',args.norm,
               '-r',args.resolution,'--oe',args.oe,'--sparse',args.sparse,'--species',args.species]
    subprocess.run(cmd,check=True,env=CDesk_env)

# HiC: 4.TAD
def HiC_tad(args):
    python_script = os.path.join(root_dir,'5.HiC','4.TAD','TAD.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-o',args.output,
               "--insulation_window",str(args.insulation_window),"--directionality_window",str(args.directionality_window),"--expand",str(args.expand)]
    subprocess.run(cmd,check=True,env=CDesk_env)

# HiC: 5. Compartment
def HiC_compartment(args):
    python_script = os.path.join(root_dir,'5.HiC','5.Compartment','Compartment.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/');args.GC = args.GC.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output);args.GC = os.path.abspath(args.GC) if args.GC !='no' else 'no'
    cmd = [CDesk_env['python3_7'], python_script,'-i',args.input,'-r',str(args.resolution),'-o',args.output,
               '-t',str(args.thread),'--GC',args.GC,'--species',args.species,
               '--width',str(args.width),'--height',str(args.height)]
    subprocess.run(cmd,check=True,env=CDesk_env)

# HiC: 6. Loop
def HiC_loop(args):
    python_script = os.path.join(root_dir,'5.HiC','6.Loop','loop.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    cmd = [CDesk_env['python3_7'],python_script,'-i',args.input,'-o',args.output,'-t',str(args.thread)]
    subprocess.run(cmd,check=True,env=CDesk_env)

# HiC: 7. Reconstruct
def HiC_reconstruct(args):
    if args.reconstruct_mode == 'flamingo':
        R_script = os.path.join(root_dir,'5.HiC','7.Reconstruction','FLAMINGO.R')
        args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
        args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
        cmd = ['Rscript', R_script,args.input,args.chr,args.domain_res,args.frag_res,args.norm,str(args.thread),args.output]
        subprocess.run(cmd,check=True,env=CDesk_env)
    elif args.reconstruct_mode == 'hickit':
        CDesk_env["DipC"] = config['software']['dipc']
        bash_script = os.path.join(root_dir,'5.HiC','7.Reconstruction','HiCkit.sh')
        args.r1 = args.r1.rstrip('/');args.r2 = args.r2.rstrip('/');args.vcf = args.vcf.rstrip('/');args.output = args.output.rstrip('/')
        args.r1 = os.path.abspath(args.r1);args.r2 = os.path.abspath(args.r2);args.vcf = os.path.abspath(args.vcf) if args.vcf !='' else '';args.output = os.path.abspath(args.output)
        cmd = [bash_script,'-vcf',args.vcf,'-mat',args.mat,'-pat',args.pat,'-t',str(args.thread),
                '-r1',args.r1,'-r2',args.r2,'-species',args.species,'-out',args.prefix,'-o',args.output]
        subprocess.run(cmd,check=True,env=CDesk_env)

# HiC: 8. PSS
def HiC_pss(args):
    python_script = os.path.join(root_dir,'5.HiC','8.PSS','pss.py')
    args.input = args.input.rstrip('/');args.output = args.output.rstrip('/')
    args.input = os.path.abspath(args.input);args.output = os.path.abspath(args.output)
    cmd = [CDesk_env['python3_7'],python_script,'-i',args.input,'-o',args.output,
            '--bin',args.bin,'--curve_mean_min',args.curve_mean_min,'--curve_bin_min',args.curve_bin_min,'--curve_x_min',args.curve_x_min,'--curve_x_max',args.curve_x_max,
            '--expcurve_y_bias',args.expcurve_y_bias,'--expcurve_x_min',args.expcurve_x_min,'--expcurve_x_max',args.expcurve_x_max,'--heatmap_x_min',args.heatmap_x_min,
            '--heatmap_x_max',args.heatmap_x_max,'--width',args.width,'--height',args.height]
    subprocess.run(cmd,check=True,env=CDesk_env)

# HiC: 9. Compare
def HiC_compare(args):
    args.hic1 = args.hic1.rstrip('/');args.hic2 = args.hic2.rstrip('/');args.output = args.output.rstrip('/')
    args.hic1 = os.path.abspath(args.hic1);args.hic2 = os.path.abspath(args.hic2);args.output = os.path.abspath(args.output)
    python_script = os.path.join(root_dir,'5.HiC','9.Contact_compare','compare.py')
    cmd = [CDesk_env['python3_7'],python_script,'--hic1',args.hic1,'--hic2',args.hic2,'-o',args.output,'--chr',args.chr,'--A_min',str(args.A_min)]
    subprocess.run(cmd,check=True,env=CDesk_env)

def parse_arguments():
    # CDesk ArgumentParser Object
    parser = argparse.ArgumentParser(prog='CDesk', description="CDesk multiomics pipeline")
    subparsers = parser.add_subparsers(dest='omics', required=True, help="Choose an omic to run the script")

    # tools
    tools_parser = subparsers.add_parser('tools', help='Some other tools')
    tools_subparsers = tools_parser.add_subparsers(help='Some other tools', title='tools', dest='tools_command')

    # tools: 1. download
    download_parser = tools_subparsers.add_parser('download', help='Download SRR/ERR data')
    # Required parameters
    download_parser.add_argument('--input','-i', required=True, help='The input sample list file')
    download_parser.add_argument('--output','-o', required=True, help='Specify the output directory')
    download_parser.add_argument('--key','-k', required=True, help='Specify the ASCP Key Path')
    download_parser.add_argument('--thread','-t', default=5,type=int,help='Specify the number of threads, default: 5')

    # tools: 2. prepare
    prepare_parser = tools_subparsers.add_parser('prepare', help='Prepare input csv')
    prepare_parser.add_argument('--input','-i', required=True, help='The input directory')
    prepare_parser.add_argument('--output','-o', required=True, help='Specify the output directory')
    prepare_parser.add_argument("--pair",default='',type=str, help="Pair suffix, comma separate")
    prepare_parser.add_argument("--single",default='',type=str,help='Single suffix')

    # bulkRNA
    bulkRNA_parser = subparsers.add_parser('bulkRNA', help='bulkRNA-seq pipeline')
    bulkRNA_subparsers = bulkRNA_parser.add_subparsers(help='bulkRNA-seq pipeline', title='bulkRNA-seq pipeline', dest='bulkRNA_command')

    # bulkRNA: 1. preprocess
    bulkPreprocessing_parser = bulkRNA_subparsers.add_parser('preprocess', help='bulkRNA-seq preprocessing')
    # Required parameters
    bulkPreprocessing_parser.add_argument('--input','-i', required=True, help='The input sequencing data information file')
    bulkPreprocessing_parser.add_argument('--output','-o', required=True, help='Specify the output directory')
    bulkPreprocessing_parser.add_argument('--species','-s', required=True, help='Specify the species',
                                      choices=list(config['data'].keys()))
    # Optional parameters
    bulkPreprocessing_parser.add_argument('-bw', action='store_true', help='If specified, perform a bam -> bigwig file transfer (optional)')
    bulkPreprocessing_parser.add_argument('-te', action='store_true', help='If specified, perform a TE expression analysis (optional)')
    bulkPreprocessing_parser.add_argument('--thread','-t', help='Specify number of threads (default is 8)',default=8,type=int)

    # bulkRNA: 2. cor
    bulkQC_parser = bulkRNA_subparsers.add_parser('correlation', help='bulkRNA-seq sample correlation')
    # Required parameters
    bulkQC_parser.add_argument('--input','-i', required=True, help='Specify the input gene expression file (.csv), column name as sample, row name as gene')
    bulkQC_parser.add_argument('--output','-o', required=True, help='Specify the output directory')
    bulkQC_parser.add_argument('--group',required=True ,help='The grouping file(csv,txt,tsv)')
    bulkQC_parser.add_argument('--batch', default='no', help='Specify the batch effect removing method, default: no',choices=['no','removeBatchEffect','combat'])
    bulkQC_parser.add_argument('--width',default=8,type=int, help='The plotting width, default: 8')
    bulkQC_parser.add_argument('--height',default=6,type=int, help='The plotting height, default: 6')

    # bulkRNA: 3. DEG
    bulkDEGD_parser = bulkRNA_subparsers.add_parser('DEG', help='bulkRNA-seq differential gene expression analysis')
    bulkDEGD_subparser = bulkDEGD_parser.add_subparsers(dest='DEG_mode', required=True, help="Choose a mode to run the script")
    # DEseq2
    bulkDEGD_deseq2 = bulkDEGD_subparser.add_parser('deseq2',help='Perform DEseq2 differential gene expression analysis')
    bulkDEGD_deseq2.add_argument('-i','--input',required=True,help='Input count matrix for DESeq2')
    bulkDEGD_deseq2.add_argument('-o','--output',required=True,help='Output directory')
    bulkDEGD_deseq2.add_argument('--group',required=True,help='Grouping file')
    bulkDEGD_deseq2.add_argument('-p',help='Whether to draw plot or not',action='store_true')
    bulkDEGD_deseq2.add_argument('--gene',help='Interested genes file',default='NO')
    bulkDEGD_deseq2.add_argument('--top_num',help='Number of top differential expression genes for heatmap if no gene file provided, default: 500',default=500,type=int)
    bulkDEGD_deseq2.add_argument('--fc',help='fold change threshold of DEGs, default: 1',type=float,default=1)
    bulkDEGD_deseq2.add_argument('--pval',help='p_adjusted threshold of DEGs, default: 0.05',type=float,default=0.05)
    bulkDEGD_deseq2.add_argument('--width',help='Plot width, default: 5',type=float,default=5)
    bulkDEGD_deseq2.add_argument('--height',help='Plot height, default: 5',type=float,default=5)
    # adjusted_t
    bulkDEGD_adjust_t = bulkDEGD_subparser.add_parser('adjusted_t',help='Perform adjusted_t differential gene expression analysis')
    bulkDEGD_adjust_t.add_argument('-i','--input',required=True,help='Input matrix for adjusted_t')
    bulkDEGD_adjust_t.add_argument('-o','--output',required=True,help='Output directory')
    bulkDEGD_adjust_t.add_argument('--group',required=True,help='Grouping file')
    bulkDEGD_adjust_t.add_argument('-p',help='Whether to draw plot or not',action='store_true')
    bulkDEGD_adjust_t.add_argument('--gene',help='Interested genes file',default='NO')
    bulkDEGD_adjust_t.add_argument('--top_num',help='Number of top differential expression genes for heatmap if no gene file provided, default: 500',default=500,type=int)
    bulkDEGD_adjust_t.add_argument('--fc',help='fold change threshold of DEGs, defaullt: 1',type=float,default=1)
    bulkDEGD_adjust_t.add_argument('--pval',help='p_adjusted threshold of DEGs, default: 0.05',type=float,default=0.05)
    bulkDEGD_adjust_t.add_argument('--width',help='Plot width, default: 5',type=float,default=5)
    bulkDEGD_adjust_t.add_argument('--height',help='Plot height, default: 5',type=float,default=5)
    # gfold
    bulkDEGD_gfold = bulkDEGD_subparser.add_parser('gfold',help='Perform adjusted_t differential gene expression analysis')
    bulkDEGD_gfold.add_argument('-i','--input',required=True,help='Input bam grouping file')
    bulkDEGD_gfold.add_argument('-o','--output',required=True,help='Output directory')
    bulkDEGD_gfold.add_argument('-s','--species',required=True,help='Specify the species',choices=list(config['data'].keys()))
    bulkDEGD_gfold.add_argument('-p',help='Whether to draw plot or not',action='store_true')
    bulkDEGD_gfold.add_argument('-t','--thread',help='Number of threads, default: 20',type=int,default=20)
    bulkDEGD_gfold.add_argument('--gene',help='Interested gene file',default='NO')
    bulkDEGD_gfold.add_argument('--top_num',help='Number of top differential expression genes for heatmap if no gene file provided, default: 500',default=500,type=int)
    bulkDEGD_gfold.add_argument('--gfold',help='GFold threshold of DEGs, default: 1',type=float,default=1)
    bulkDEGD_gfold.add_argument('--width',help='Plot width, default: 5',type=float,default=5)
    bulkDEGD_gfold.add_argument('--height',help='Plot height, default: 5',type=float,default=5)

    # bulkRNA: 4. enrich
    bulkEnrich_parser = bulkRNA_subparsers.add_parser('enrich', help='bulkRNA-seq gene functional enrichment analysis')
    bulkEnrich_subparser = bulkEnrich_parser.add_subparsers(dest='enrich_mode', required=True, help="Choose a mode to run the script")
    # enrich
    bulk_enrich = bulkEnrich_subparser.add_parser('analyze', help='Perform the functional enrichment analysis')
    bulk_enrich.add_argument('-i', '--input',required=True, help='The single column file of interested genes (SYMBOL)')
    bulk_enrich.add_argument('--type',help='Specify the analysis type, single/multiple samples',required=True,choices=["single","multi"])
    bulk_enrich.add_argument('-s','--species',help='Species',default='no',choices=["human", "rat","mouse","chicken","pig","no"])
    bulk_enrich.add_argument('-o','--output', required=True, help='Output directory')
    bulk_enrich.add_argument('--custom',default='no', help='The reference customer file containing two columns for custom analysis (every row is consisted of two factors: the customer term name and gene of interests separated by tab)')
    bulk_enrich.add_argument('--width', default='10',type=int, help='Plot width, default: 10')
    bulk_enrich.add_argument('--height', default='6', type=int,help='Plot height, default: 6')
    # plot
    bulk_plot = bulkEnrich_subparser.add_parser('plot', help='Plot the functional enrichment result')
    bulk_plot.add_argument('-i','--input', required=True, help='The enrichment result file')
    bulk_plot.add_argument('-o','--output',required=True, help='Output directory')
    bulk_plot.add_argument('--type',help='Specify the analysis type, single/multiple samples',required=True,choices=["single","multi"])
    bulk_plot.add_argument('--width', default='10',type=int, help='Plot width, default: 10')
    bulk_plot.add_argument('--height', default='6', type=int,help='Plot height, default: 6')
    # GSEA
    bulkGSEA = bulkEnrich_subparser.add_parser('GSEA', help='bulkRNA-seq GSEA analysis')
    bulkGSEA.add_argument("-i","--input",required=True,type=str, help="The ranked gene list file (e.g., DEG result file)")
    bulkGSEA.add_argument("-o","--output",required=True,  type=str, help="Output directory")
    bulkGSEA.add_argument("-s","--species",required=True,type=str, help="Specify the species",choices=['human','mouse','pig','chicken','rat'])
    bulkGSEA.add_argument("--path",type=str,default='NO', help="Specify the paths to plot")   
    bulkGSEA.add_argument("--cols",default='gene_name,log2FoldChange',type=str, help="Columns used, default:gene_name,log2FoldChange")
    bulkGSEA.add_argument('--width', default=7,type=float, help='Plot width, default: 7')
    bulkGSEA.add_argument('--height', default=7, type=float,help='Plot height, default: 7')

    # bulkRNA: 5. Similarity Analysis
    bulkSimilarity_parser = bulkRNA_subparsers.add_parser('similarity', help='bulkRNA-seq similarity analysis')
    # Required parameters
    bulkSimilarity_parser.add_argument('-i','--input', required=True, help='The gene expression list file')
    bulkSimilarity_parser.add_argument('-o','--output', required=True, help='Output directory')
    bulkSimilarity_parser.add_argument('--group',required=True,help='The grouping file')
    # Optional parameters
    bulkSimilarity_parser.add_argument('--gene',default='All',help='Specify the gene list, default: ALL')
    bulkSimilarity_parser.add_argument('--batch', default='no', help='Specify the batch effect removing method',choices=['no','removeBatchEffect','combat'])
    bulkSimilarity_parser.add_argument('--width',default=10,type=int, help='The plotting width, default: 10')
    bulkSimilarity_parser.add_argument('--height',default=8,type=int, help='If plotting height, default:8')

    # bulkRNA: 6. Clustering
    bulkClustering_parser = bulkRNA_subparsers.add_parser('cluster', help='bulkRNA-seq gene clustering analysis')
    bulkClustering_subparser = bulkClustering_parser.add_subparsers(dest='cluster_mode', required=True, help="Choose to use Kmean or WGCNA")
    # WGCNA
    bulkWGCNA_parser = bulkClustering_subparser.add_parser('WGCNA', help='bulkRNA-seq WGCNA analysis')
    bulkWGCNA_parser.add_argument('-i','--input', required=True, help='The input gene expression matrix file.')
    bulkWGCNA_parser.add_argument('--pheno', required=True, help='The sample trait information file.')
    bulkWGCNA_parser.add_argument('--trait',required=True, help='The phenotypes specified to calculate correlations with gene modules.')
    bulkWGCNA_parser.add_argument('-o','--output',required=True,help='Output directory')
    # Kmean
    bulkKmean_parser = bulkClustering_subparser.add_parser('kmean', help='bulkRNA-seq Knmean gene clustering')
    bulkKmean_parser.add_argument('-i','--input', required=True, help='The input gene expression matrix file.')
    bulkKmean_parser.add_argument('--group', required=True, help='The grouping csv file')
    bulkKmean_parser.add_argument('--cluster',type=int,default=6,help='Number of clusters for K-means clustering, default: 6')
    bulkKmean_parser.add_argument('-o','--output',required=True,help='Output directory')
    bulkKmean_parser.add_argument('--method',default='correlation',help='Distance measure to be used for clustering, default: correlation',
                                  choices=["euclidean", "maximum", "manhattan", "canberra", "binary", "pearson", "abspearson", "abscorrelation", "correlation","spearman", "kendall"])
    bulkKmean_parser.add_argument('--height',default=10,help='Output image height, default: 10',type=float)
    bulkKmean_parser.add_argument('--width',default=8,help='Output image width, defaullt: 8',type=float)
    bulkKmean_parser.add_argument('--gene',default='no',help='Spcefify the gene list txt file (optional)')

    # bulkRNA: 7. AlternativeSplicingDetection
    bulkSplice_parser = bulkRNA_subparsers.add_parser('splice', help='bulkRNA-seq alternative splicing detection')
    bulkSplice_subparser = bulkSplice_parser.add_subparsers(dest='Splice_mode', required=True, help="Choose a mode to run the script")
    # Splice detect
    bulkSplice_detect = bulkSplice_subparser.add_parser('detect', help='Detect the differentail splicing events by rMATs based on the bam file')
    bulkSplice_detect.add_argument('--b1',type=str,required=True,help="The first BAM files txt")
    bulkSplice_detect.add_argument('-s','--species',type=str,required=True,choices=list(config['data'].keys()),help="Specify the species")
    bulkSplice_detect.add_argument('-o','--output',type=str,required=True,help="The output directory")
    # Optional
    bulkSplice_detect.add_argument('--b2',type=str,default='No',help="The second BAM files txt")
    bulkSplice_detect.add_argument('--type',choices=['paired','single'],default='paired',help="Type of read: paired/single, default:paired")
    bulkSplice_detect.add_argument('-t','--thread', type=int, default=10, help="Number of threads, default: 10")
    bulkSplice_detect.add_argument('--length',type=int,default=150,help="The length of each read, default: 150")
    bulkSplice_detect.add_argument('--variable_read_length',action='store_true',help="Allow reads with lengths that differ from read Length")
    bulkSplice_detect.add_argument('--allow_clipping',action='store_true',help="Allow alignments with soft or hard clipping to be used")
    # Splice draw
    bulkSplice_draw = bulkSplice_subparser.add_parser('draw', help='Draw the sashimi plot to visualize the differential splicing events based on the bam files')
    bulkSplice_draw.add_argument('--b1',type=str,required=True,help="The first BAM files txt")
    bulkSplice_draw.add_argument('-s','--species',type=str,required=True,help="Specify the species")
    bulkSplice_draw.add_argument('-o','--output',type=str,required=True,help="The output directory")
    bulkSplice_draw.add_argument('--region',type=str,required=True,help="The genome region coordinates: format:{chromosome}:{strand}:{start}:{end}")
    # Optional
    bulkSplice_draw.add_argument('--l1',type=str,help="The first sample name",default = 'sample1')
    bulkSplice_draw.add_argument('--l2',type=str,help="The second sample name",default = 'sample2')
    bulkSplice_draw.add_argument('--group',type=str,default='No',help="The path to a .gf file which groups the replicates")
    bulkSplice_draw.add_argument('--b2',type=str,default='No',help="The second BAM files txt")
    bulkSplice_draw.add_argument('--exon_s',type=int, default=1,help="How much to scale down exon, default: 1")
    bulkSplice_draw.add_argument('--intron_s',type=int, default=1,help="How much to scale down introns, default: 1")
 
    # scRNA
    scRNA_parser = subparsers.add_parser('scRNA', help='scRNA pipeline')
    scRNA_subparser = scRNA_parser.add_subparsers(help='scRNA pipeline', title='scRNA pipeline', dest='scRNA_command')
   
    # scRNA: 1. preprocess
    scRNApreprocess_parser = scRNA_subparser.add_parser('preprocess', help='scRNA preprocess command')
    scRNApreprocess_subparser = scRNApreprocess_parser.add_subparsers(dest='scRNA_preprocess_mode',required=True,help='Choose a mode')
    # cellranger
    scRNApreprocess_cellranger = scRNApreprocess_subparser.add_parser('cellranger',help='Perform cellranger preprocess')
    scRNApreprocess_cellranger.add_argument('--input','-i', required=True, help='Input fq information file')
    scRNApreprocess_cellranger.add_argument('--species','-s', required=True, help='Specify the species',choices=list(config['data'].keys()))
    scRNApreprocess_cellranger.add_argument('--output','-o', required=True, help='Output directory')
    scRNApreprocess_cellranger.add_argument('--thread','-t',help='Specify number of threads (default is 8)',default=8,type=int)
    scRNApreprocess_cellranger.add_argument('--chemistry',type=str,default='auto',help='Chemistry')
    # DrSeq
    scRNApreprocess_drseq = scRNApreprocess_subparser.add_parser('drseq',help='Perform DrSeq preprocess')
    scRNApreprocess_drseq.add_argument('--input','-i', required=True, help='Input fq information file')
    scRNApreprocess_drseq.add_argument('--species','-s', required=True, help='Specify the species',choices=list(config['data'].keys()))
    scRNApreprocess_drseq.add_argument('--output','-o', required=True, help='Output directory')
    scRNApreprocess_drseq.add_argument('--thread','-t',help='Specify number of threads (default is 8)',default=8,type=int)
    scRNApreprocess_drseq.add_argument('--barcode',help='The barcode range, default: 1:12',default='1:12')
    scRNApreprocess_drseq.add_argument('--umi',help='The UMI range, deafult: 13:20',default='13:20')
    # smartseq
    scRNApreprocess_smartseq = scRNApreprocess_subparser.add_parser('smartseq',help='Perform smartseq preprocess')
    scRNApreprocess_smartseq.add_argument('--input','-i', required=True, help='Input fq information file')
    scRNApreprocess_smartseq.add_argument('--output','-o', required=True, help='Specify the output directory')
    scRNApreprocess_smartseq.add_argument('--species','-s', required=True, help='Specify the species')
    scRNApreprocess_smartseq.add_argument('-bw', action='store_true', help='If specified, perform a bam -> bigwig file transfer (optional)')
    scRNApreprocess_smartseq.add_argument('-te', action='store_true', help='If specified, perform a TE expression analysis (optional)')
    scRNApreprocess_smartseq.add_argument('--thread','-t', help='Specify number of threads (default is 8)',default=8,type=int)
    # singleron
    scRNApreprocess_singleron = scRNApreprocess_subparser.add_parser('singleron',help='Perform singleron preprocess')
    scRNApreprocess_singleron.add_argument('--input','-i', required=True, help='Input fq information file')
    scRNApreprocess_singleron.add_argument('--output','-o', required=True, help='Output directory')
    scRNApreprocess_singleron.add_argument('--species','-s', required=True, help='Specify the species',choices=list(config['data'].keys()))
    scRNApreprocess_singleron.add_argument('--thread','-t', help='Specify number of threads (default is 8)',default=8,type=int)
    # dnbc
    scRNAdnbc_parser = scRNApreprocess_subparser.add_parser('dnbc',help='Perform dnbc pipeline')
    scRNAdnbc_parser.add_argument('--input','-i', required=True, help='Input fq information file')
    scRNAdnbc_parser.add_argument('--output','-o', required=True, help='Output directory')
    scRNAdnbc_parser.add_argument('--species','-s', required=True, help='Specify the species',choices=list(config['data'].keys()))
    scRNAdnbc_parser.add_argument('--thread','-t', help='Specify number of threads (default is 10)',default=10,type=int)

    # scRNA: 2. Clustering
    scRNAclustering_parser = scRNA_subparser.add_parser('cluster', help='scRNA clustering command')
    scRNAclustering_parser.add_argument('-i','--input',required=True, help='Input files directory')
    scRNAclustering_parser.add_argument('-o','--output',required=True, help='Ouput directory')
    scRNAclustering_parser.add_argument('-n','--name',required=True, help='Output prefix name')
    scRNAclustering_parser.add_argument('--mode',required=True, help='Seurat or Scanpy',choices=['seurat','scanpy'])
    scRNAclustering_parser.add_argument('--min_cells', type=int, default=3, help="minimum cells threshold for data filtration preprocess, default: 3")
    scRNAclustering_parser.add_argument('--min_features', type=int, default=200, help="minimum features threshold data filtration preprocess, default: 200")
    scRNAclustering_parser.add_argument('--nFeature_RNA_min', type=int, default=200, help="clustering feature minimum, default: 200")
    scRNAclustering_parser.add_argument('--nFeature_RNA_max', type=int, default=2500, help="clustering feature maximum, default: 2500")
    scRNAclustering_parser.add_argument('--mt_percent', type=float, default=5, help="clustering mitochondria percent threshold, default: 5")
    scRNAclustering_parser.add_argument('--variable_features', type=int, default=2000, help="clustering variable features, default: 2000")
    scRNAclustering_parser.add_argument('--dim_prefer', type=int, default=30, help="clustering dimesions, default: 30")
    scRNAclustering_parser.add_argument('--res', type=float, default=1, help="clustering resolution, default: 1")
    scRNAclustering_parser.add_argument('--width',default=10,type=int, help='The plotting width, default: 10')
    scRNAclustering_parser.add_argument('--height',default=8,type=int, help='The plotting width, default: 8')
    
    # scRNA: 3. Annotation
    scRNAannotation_parser = scRNA_subparser.add_parser('annotation', help='scRNA clusters annotation')
    scRNAannotation_subparser = scRNAannotation_parser.add_subparsers(dest='scRNA_annotation_mode',required=True,help='Choose a mode')
    # Marker
    scRNAannotation_marker = scRNAannotation_subparser.add_parser('marker',help='scRNA annotation using markers')
    scRNAannotation_marker.add_argument('-i','--input', required=True, help='The input .rds data to annotate')
    scRNAannotation_marker.add_argument('--marker', required=True, help='The marker file with cell marker information')
    scRNAannotation_marker.add_argument('--meta', required=True, help='The meta colname of reference data used')
    scRNAannotation_marker.add_argument('-o','--output', required=True, help='Output directory')
    scRNAannotation_marker.add_argument('--cluster', default='umap', help='Plot type',choices=['umap','tsne'])
    scRNAannotation_marker.add_argument('--expression_thre', type=float,default=1.5, help='The average expression threshold')
    scRNAannotation_marker.add_argument('--percentage_thre', type=float,default=0.7, help='The express > 0 percentage threshold')
    scRNAannotation_marker.add_argument('--marker_thre', type=float,default=0.7, help='The proportion threshold for passing the screening')
    scRNAannotation_marker.add_argument('--width',default=10,type=int, help='The plotting width, default: 10')
    scRNAannotation_marker.add_argument('--height',default=8,type=int, help='The plotting width, default: 8')
    # TransferLabel
    scRNAannotation_transfer = scRNAannotation_subparser.add_parser('transfer',help='scRNA annotation using TransferLabel')
    scRNAannotation_transfer.add_argument('--query', required=True, help='The query .rds data to annotate')
    scRNAannotation_transfer.add_argument('--ref', required=True, help='The reference .rds data')
    scRNAannotation_transfer.add_argument('--meta', required=True, help='The meta colname of reference data used')
    scRNAannotation_transfer.add_argument('-o','--output', required=True, help='Output directory')
    scRNAannotation_transfer.add_argument('--cluster', default='umap', help='Plot type',choices=['umap','tsne'])
    scRNAannotation_transfer.add_argument('--nfeatures', default=5000,type=int,help='The number of variable features')
    scRNAannotation_transfer.add_argument('--dims', default=30,type=int,help='The number of PC dimensions used')
    scRNAannotation_transfer.add_argument('--width',default=10,type=int, help='The plotting width, default: 10')
    scRNAannotation_transfer.add_argument('--height',default=8,type=int, help='The plotting width, default: 8')

    # scRNA: 4. marker
    scRNAmarker_parser = scRNA_subparser.add_parser('marker', help='scRNA marker gene detection command')
    scRNAmarker_subparser = scRNAmarker_parser.add_subparsers(dest='scRNA_marker_mode',required=True,help='Choose a mode')
    # all
    scRNAmarker_all = scRNAmarker_subparser.add_parser('all',help='Perform FindAllMarkers')
    scRNAmarker_all.add_argument('-i','--input', required=True, help='Input Seurat object rds file')
    scRNAmarker_all.add_argument('--meta', required=True, help='Specify the meta data column')
    scRNAmarker_all.add_argument('-fc', default=0.5,type=float,help='Log Fold Change threshold is used to screen for differentially expressed genes (default:0.5)')
    scRNAmarker_all.add_argument('-p', default=0.05,type=float,help='Specific Adjusted p-value threshold, used to determine the statistical significance of gene expression differences (default:0.05)')
    scRNAmarker_all.add_argument('-m',default=0.25,type=float,help='Minimum percentage of expressed cells, indicating at least what percentage of cells a gene must be expressed in to participate in the analysis (default:0.25)')
    scRNAmarker_all.add_argument('-o','--output', required=True,help='Output directory')
    scRNAmarker_all.add_argument('--width', default=16,type=int,help='The plot width, default: 16')
    scRNAmarker_all.add_argument('--height', default=14,type=int,help='The plot height, default: 14')
    # 2
    scRNAmarker_2 = scRNAmarker_subparser.add_parser('2group',help='Perform marker gene detection in 2 specified groups')
    scRNAmarker_2.add_argument('-i','--input', required=True, help='Input Seurat object rds file')
    scRNAmarker_2.add_argument('-fc', default=0.5,type=float,help='Log Fold Change threshold is used to screen for differentially expressed genes (default:0.5)')
    scRNAmarker_2.add_argument('-p', default=0.05,type=float,help='Specific Adjusted p-value threshold, used to determine the statistical significance of gene expression differences (default:0.05)')
    scRNAmarker_2.add_argument('-m',default=0.25,type=float,help='Minimum percentage of expressed cells, indicating at least what percentage of cells a gene must be expressed in to participate in the analysis (default:0.25)')
    scRNAmarker_2.add_argument('-o','--output',required=True,help='Output directory')
    scRNAmarker_2.add_argument('--type1',type=str,required=True,help='Specify the first type')
    scRNAmarker_2.add_argument('--type2',type=str,required=True,help='Specify the second type')
    scRNAmarker_2.add_argument('--meta', required=True,help='Specify the meta data column')
    scRNAmarker_2.add_argument('--width', default=10,type=int,help='The plot width, default: 16')
    scRNAmarker_2.add_argument('--height', default=8,type=int,help='The plot height, default: 14')
    
    # scRNA: 5. trajectory
    scRNAtrajectory_parser = scRNA_subparser.add_parser('trajectory', help='scRNA trajectory command')
    scRNAtrajecory_subparser = scRNAtrajectory_parser.add_subparsers(dest='scRNA_trajectory_mode',required=True,help='Choose a mode')
    # monocle3
    scRNAtrajecory_monocle = scRNAtrajecory_subparser.add_parser('monocle',help='Perform monocle trajectory analysis')
    scRNAtrajecory_monocle.add_argument('--input','-i', required=True, help='Input rds file, clustered and annotated seurat object')
    scRNAtrajecory_monocle.add_argument('--meta','-m', required=True, help='Meta data for trajectory analysis, e.g., celltype')
    scRNAtrajecory_monocle.add_argument('--output','-o', required=True, help='Output directory for the results')
    scRNAtrajecory_monocle.add_argument('--start', required=True, help='Start point for trajectory analysis, e.g., NK')
    scRNAtrajecory_monocle.add_argument("--width", type=int, default=8,help="Plot width, default: 8")
    scRNAtrajecory_monocle.add_argument("--height", type=int, default=8,help="Plot height, default: 8")
    # DiffusionMap
    scRNAtrajecory_diffusionmap = scRNAtrajecory_subparser.add_parser('diffusion',help='Perform diffusion map trajectory analysis')
    scRNAtrajecory_diffusionmap.add_argument('--input','-i', required=True, help='Input rds file, clustered and annotated seurat object')
    scRNAtrajecory_diffusionmap.add_argument('--output','-o', required=True, help='Output directory for the results')
    scRNAtrajecory_diffusionmap.add_argument('--meta','-m', required=True, help='Meta data for trajectory analysis, e.g., celltype')
    scRNAtrajecory_diffusionmap.add_argument('--start',required=True, help='Start point for trajectory analysis, e.g., NK')
    scRNAtrajecory_diffusionmap.add_argument("--width", type=int, default=8,help="Plot width, default: 8")
    scRNAtrajecory_diffusionmap.add_argument("--height", type=int, default=8,help="Plot height, default: 8")
    # velocity
    scRNAtrajecory_velocity = scRNAtrajecory_subparser.add_parser('velocity',help='Perform velocity trajectory analysis')
    scRNAtrajecory_velocity.add_argument('--cellranger', required=True, help='Cellranger output directory')
    scRNAtrajecory_velocity.add_argument('--gtf',default='',help='Specify the gtf file')
    scRNAtrajecory_velocity.add_argument('--rds', required=True, help='rds file, clustered and annotated seurat object for velocity analysis')
    scRNAtrajecory_velocity.add_argument('--genes', type=str,default='',help='Interested genes file')
    scRNAtrajecory_velocity.add_argument("--meta",'-m',required=True, type=str, help="Meta column used")
    scRNAtrajecory_velocity.add_argument("--width", type=int, default=10,help="Plot width, default: 10")
    scRNAtrajecory_velocity.add_argument("--height", type=int, default=10,help="Plot height, default: 10")
    scRNAtrajecory_velocity.add_argument('--output','-o', required=True, help='Output directory for the results')
    scRNAtrajecory_velocity.add_argument('--thread','-t', help='Specify number of threads (default is 10)',default=10,type=int)
    # CStreet
    scRNAtrajecory_cstreet = scRNAtrajecory_subparser.add_parser('cstreet',help='Perform CStreet trajectory analysis')
    scRNAtrajecory_cstreet.add_argument("--expression", type=str, help="Input expression matrixes list file")
    scRNAtrajecory_cstreet.add_argument("--state", type=str, help="Input cell state list file")
    scRNAtrajecory_cstreet.add_argument("--name","-n", type=str,default='',help="Output directory name")
    scRNAtrajecory_cstreet.add_argument("--output","-o", type=str, help="Output directory")

    # scRNA: 6. similarity
    scRNAsimilarity_parser = scRNA_subparser.add_parser('similarity', help='Test 2 scRNA data similarity')
    scRNAsimilarity_parser.add_argument('--sample1',required=True, help='Seurat data 1')
    scRNAsimilarity_parser.add_argument('--sample2',required=True, help='Seurat data 2')
    scRNAsimilarity_parser.add_argument('--meta1',required=True, help='Meta used in data 1')
    scRNAsimilarity_parser.add_argument('--meta2',required=True, help='Meta used in data 2')
    scRNAsimilarity_parser.add_argument('--type1',required=True, help='Data 1 group file')
    scRNAsimilarity_parser.add_argument('--type2',required=True, help='Data 2 group file')
    scRNAsimilarity_parser.add_argument('--output','-o',required=True, help='Output directory')
    scRNAsimilarity_parser.add_argument('--nfeatures_used', default=2000,type=int, help='The number of variable features, default: 2000')
    scRNAsimilarity_parser.add_argument('--integrate_features', default=2000,type=int, help='The number of features for integration, default: 2000')
    scRNAsimilarity_parser.add_argument('--width', default=10,type=int, help='Plot width, default: 10')
    scRNAsimilarity_parser.add_argument('--height', default=10,type=int, help='Plot height, default: 10')

    # scRNA: 7. interaction
    scRNAinteraction_parser = scRNA_subparser.add_parser('interaction', help='scRNA cell interation command')
    scRNAinteraction_subparser = scRNAinteraction_parser.add_subparsers(dest='scRNA_interaction_mode',required=True,help='Choose a mode')
    # cellchat
    scRNAinteraction_cellchat = scRNAinteraction_subparser.add_parser('cellchat',help='Perform cellchat analysis')
    scRNAinteraction_cellchat.add_argument('--input','-i', required=True, help='Input Seurat object rds file')
    scRNAinteraction_cellchat.add_argument('--thread','-t', type=int,default=16, help='Number of threads, default: 16')
    scRNAinteraction_cellchat.add_argument('--output','-o', required=True, help='Output directory')
    scRNAinteraction_cellchat.add_argument('--species','-s', required=True, help='Species (human or mouse)',choices=["mouse","human"])
    scRNAinteraction_cellchat.add_argument('--group', required=True, help="Grouping variable (seurat_clusters or celltype......)")
    scRNAinteraction_cellchat.add_argument("--width", type=int, default=8,help="Plot width, default: 8")
    scRNAinteraction_cellchat.add_argument("--height", type=int, default=8,help="Plot height, default: 8")
    # pyscenic
    scRNAinteraction_pyscenic = scRNAinteraction_subparser.add_parser('pyscenic',help='Perform pyscenic analysis')
    scRNAinteraction_pyscenic.add_argument('--input','-i', required=True, help='Input file, h5ad/csv/tsv format')
    scRNAinteraction_pyscenic.add_argument('--output','-o', required=True, help='Output directory')
    scRNAinteraction_pyscenic.add_argument('--tf', required=True, help='TF list file')
    scRNAinteraction_pyscenic.add_argument('--db', required=True, help='RcisTarget database directory')
    scRNAinteraction_pyscenic.add_argument('--species','-s', required=True, help='Species (human or mouse, hg/mm)')
    scRNAinteraction_pyscenic.add_argument('--thread','-t', type=int,default=16, help='Number of threads, default: 16')
    scRNAinteraction_pyscenic.add_argument('--auc',type=float,default=0.05,help='AUC threshod')
    scRNAinteraction_pyscenic.add_argument('--nes',type=float,default=3.0,help='Normalized Enrichment Score threshod')
    scRNAinteraction_pyscenic.add_argument('--normalize',type=str,default='False',help='Normalize or not',choices=['True','False'])
    scRNAinteraction_pyscenic.add_argument('--scale',type=str,default='False',help='Scale or not',choices=['True','False'])
    scRNAinteraction_pyscenic.add_argument('--log',type=str,default='False',help='Log or not',choices=['True','False'])
    scRNAinteraction_pyscenic.add_argument("--top_regulons", type=int, default=20, help="Show top N regulons")
    scRNAinteraction_pyscenic.add_argument("--top_targets", type=int, default=20, help="Show top N targets genes for each TF")
    scRNAinteraction_pyscenic.add_argument("--plot_tf", default='None', help="Specify TFs to draw network")

    # scRNA: 8. integrate
    scRNAintegrate_parser = scRNA_subparser.add_parser('integrate', help='scRNA data integration command')
    scRNAintegrate_subparser = scRNAintegrate_parser.add_subparsers(dest='scRNA_integrate_mode',required=True,help='Choose a mode(seurat,bulk)')
    # seurat
    scRNAintegrate_seurat = scRNAintegrate_subparser.add_parser('seurat',help='Perform multiple seurat data integration')
    scRNAintegrate_seurat.add_argument('--input','-i', required=True, help='Seurat data list file')
    scRNAintegrate_seurat.add_argument('--mode', required=True, help='Choose a integration mode',choices=['merge','harmony','CCA'])
    scRNAintegrate_seurat.add_argument('--output','-o', required=True, help='Output directory')
    scRNAintegrate_seurat.add_argument('--min_cells', default=3,type=int, help='minimum cells threshold for data filtration preprocess, default: 3')
    scRNAintegrate_seurat.add_argument('--min_features', default=200,type=int, help='minimum feature threshold for data filtration preprocess, default: 200')
    scRNAintegrate_seurat.add_argument('--nfeatures_used', default=2000,type=int, help='The number of variable features, default: 2000')
    scRNAintegrate_seurat.add_argument('--integrate_features', default=2000,type=int, help='The number of features for integration, default: 2000')
    scRNAintegrate_seurat.add_argument('--pc_num', default=50,type=int, help='PCA dimensional reduction dimensions, default: 50')
    scRNAintegrate_seurat.add_argument('--pc_reduce', default=30,type=int, help='UMAP dimensional reduction dimensions, default: 30')
    scRNAintegrate_seurat.add_argument('--max_iter_harmony', default=20,type=int, help='Harmony maximal iteration, default: 20')
    scRNAintegrate_seurat.add_argument('--width', default=10,type=int, help='Plot width, default: 10')
    scRNAintegrate_seurat.add_argument('--height', default=10,type=int, help='Plot height, default: 10')
    scRNAintegrate_seurat.add_argument('--k_anchor', default=20,type=int, help='k.anchor for CCA integrate, default: 20')
    # bulk+scRNA
    scRNAintegrate_bulk = scRNAintegrate_subparser.add_parser('bulk',help='Integrate seurate scRNA data and bulk data')
    scRNAintegrate_bulk.add_argument('--bulk', required=True, help='bulkRNA data list file')
    scRNAintegrate_bulk.add_argument('--scRNA', required=True, help='scRNA data list file')
    scRNAintegrate_bulk.add_argument('--meta','-m', required=True, help='The meta file')
    scRNAintegrate_bulk.add_argument('--output','-o', required=True, help='Output directory')
    scRNAintegrate_bulk.add_argument('--nfeatures_used', default=2000,type=int, help='The number of variable features, default: 2000')
    scRNAintegrate_bulk.add_argument('--integrate_features', default=2000,type=int, help='The number of features for integration, default: 2000')
    scRNAintegrate_bulk.add_argument('--pc_num', default=50,type=int, help='PCA dimensional reduction dimensions, default: 50')
    scRNAintegrate_bulk.add_argument('--pc_reduce', default=30,type=int, help='Dimensional reduction dimensions, default: 30')
    scRNAintegrate_bulk.add_argument('--width', default=10,type=int, help='Plot width, default: 10')
    scRNAintegrate_bulk.add_argument('--height', default=10,type=int, help='Plot height, default: 10')

    # ATAC
    ATAC_parser = subparsers.add_parser('ATAC', help='ATAC pipeline')
    ATAC_subparsers = ATAC_parser.add_subparsers(help='ATAC pipeline', title='ATAC pipeline', dest='ATAC_command')

    # ATAC: 1. preprocess
    ATACpreprocess_parser = ATAC_subparsers.add_parser('preprocess', help='ATAC preprocess command')
    ATACpreprocess_parser.add_argument('-i','--input',required=True, help='Input fq information file')
    ATACpreprocess_parser.add_argument('-o','--output',required=True, help='Output directory')
    ATACpreprocess_parser.add_argument('-s','--species',required=True, help='Specify species',choices=list(config['data'].keys()))
    ATACpreprocess_parser.add_argument('-t','--thread',type=int,default=8, help='Number of threads, default: 8')

    # ATAC: 2. cor
    ATAC_QC_parser = ATAC_subparsers.add_parser('correlation', help='ATAC sample correlation')
    ATAC_QC_parser.add_argument("-i","--input",required=True, type=str, help="The input ATAC sample information file")
    ATAC_QC_parser.add_argument("-s","--species", required=True,type=str, help="Species",choices=list(config['data'].keys()))
    ATAC_QC_parser.add_argument("--bin", type=int,default=100000, help="Bin size for genomic binning, default: 100000")
    ATAC_QC_parser.add_argument("--step", type=int,default=1, help="Peak file partition step, default: 1")
    ATAC_QC_parser.add_argument("-o","--output",required=True,type=str, help="Output directory")
    ATAC_QC_parser.add_argument("-t","--thread", type=int,default=30, help="Threads to run, default: 30")
    ATAC_QC_parser.add_argument('--width',default=12,type=int, help='The plot width, default: 12')
    ATAC_QC_parser.add_argument('--height',default=8,type=int, help='If plot height, default:8')

    # ATAC: 3. Dynamic
    ATAC_dynamic_parser = ATAC_subparsers.add_parser('dynamic', help='ATAC dynamic pattern analysis')
    ATAC_dynamic_parser.add_argument("-i","--input",required=True, type=str, help="The input sample information file")
    ATAC_dynamic_parser.add_argument("--remove_cluster",default='',type=str, help="The cluster to remove, default: ''")
    ATAC_dynamic_parser.add_argument("-o","--output",required=True,type=str, help="The output directory")
    ATAC_dynamic_parser.add_argument("--important_index",default=0,type=int, help="Specify the group to align, 1: the latter one in meta file, 0(default): the former one in meta file")
    ATAC_dynamic_parser.add_argument("-s","--species", required=True,type=str,choices=list(config['data'].keys()), help="Species")

    # ATAC: 4. motif
    ATAC_motif_parser = ATAC_subparsers.add_parser('motif', help='ATAC motif analysis')
    ATAC_motif_subparser = ATAC_motif_parser.add_subparsers(dest='motif_mode', required=True, help="Choose to analyze or plot")
    # homer find
    ATAC_Find_homer_subparser = ATAC_motif_subparser.add_parser('homer', help='Perform homer motif finding analysis')
    ATAC_Find_homer_subparser.add_argument("-i","--input",required=True,type=str, help="The input gene/peak information file")
    ATAC_Find_homer_subparser.add_argument("-o","--output",required=True,  type=str, help="Output directory")
    ATAC_Find_homer_subparser.add_argument("-s","--species",required=True, help='Available gene in HOMER or provide the path to genome FASTA files for peak mode', type=str)
    ATAC_Find_homer_subparser.add_argument("--mode",required=True,type=str, help="Analysis mode: peak/gene",choices=['gene','peak'])
    ATAC_Find_homer_subparser.add_argument("-t","--thread",default=20,  type=int, help="Number of threads, default: 20")
    ATAC_Find_homer_subparser.add_argument("--start",default=-300,type=int, help="offset from TSS, default=-300")
    ATAC_Find_homer_subparser.add_argument("--end",default=50,type=int, help="offset from TSS, default=50")
    # meme find
    ATAC_Find_meme_subparser = ATAC_motif_subparser.add_parser('meme', help='Perform meme motif finding analysis')
    ATAC_Find_meme_subparser.add_argument("-i","--input",required=True,help="The fasta input information file")
    ATAC_Find_meme_subparser.add_argument("-o","--output",required=True,  type=str, help="Output directory")
    ATAC_Find_meme_subparser.add_argument("-t","--thread",default=10,  type=int, help="Number of threads, default: 10")
    ATAC_Find_meme_subparser.add_argument("--nmotifs",default=3,  type=int, help="Number of motifs to extract, default: 3")
    ATAC_Find_meme_subparser.add_argument("-db","--database",required=True,  type=str, help="Database file")
    # homer heatmap
    ATAC_homer_heatmap_subparser = ATAC_motif_subparser.add_parser('homer_heatmap', help='Plot the homer finding result heatmap')
    ATAC_homer_heatmap_subparser.add_argument("-i","--input",required=True, type=str, help="The homer results information csv file")
    ATAC_homer_heatmap_subparser.add_argument("-o","--output",required=True,type=str, help="The output directory")
    ATAC_homer_heatmap_subparser.add_argument("--motif",default='no',type=str, help="The specified motifs txt file")
    ATAC_homer_heatmap_subparser.add_argument("--width",default=10,type=float, help="The plot width, default: 10")
    ATAC_homer_heatmap_subparser.add_argument("--height",default=8,type=float, help="The plot height, default: 8")
    # enrich heatmap
    ATAC_enrich_heatmap_subparser = ATAC_motif_subparser.add_parser('enrich_heatmap', help='Perform the motif enriched heatmap')
    ATAC_enrich_heatmap_subparser.add_argument("--motif_bed",required=True, type=str, help="The motif bed file information csv file")
    ATAC_enrich_heatmap_subparser.add_argument("--bed",required=True, type=str, help="The input bed file information csv file")
    ATAC_enrich_heatmap_subparser.add_argument("-o","--output",required=True,type=str, help="The output directory")
    ATAC_enrich_heatmap_subparser.add_argument("-t","--thread",default=12,type=int, help="The number of threads")
    ATAC_enrich_heatmap_subparser.add_argument("-s","--species",required=True,type=str, help="Species")

    # ATAC: 5. Accessbility
    ATAC_accessbility_parser = ATAC_subparsers.add_parser('accessbility', help='ATAC accessbility analysis')
    ATAC_accessbility_parser.add_argument("--bw",required=True, help="The input bw txt file")
    ATAC_accessbility_parser.add_argument("-o","--output",required=True, help="Output directory")
    ATAC_accessbility_parser.add_argument("--mode", required=True, choices=["region", "gene"], help="Analysis mode: region/gene")
    ATAC_accessbility_parser.add_argument("-i","--input", required=True, help="Input gene region or gene list txt file")
    ATAC_accessbility_parser.add_argument("--species",help="Species",choices=list(config['data'].keys()))
    ATAC_accessbility_parser.add_argument("--method", choices=["sample", "region_list"], default="sample",help="Boxplot plotting method：sample/region list")
    ATAC_accessbility_parser.add_argument("--center",required=True, help="Average profile alignment：region mode:peak/position，gene mode:TSS/TTS/whole")
    ATAC_accessbility_parser.add_argument("--promoter_size", type=int, default=5000, help="Gene promoter region size, default: TSS upstream and downstream 5kb")
    ATAC_accessbility_parser.add_argument("--region_list",default='',help="Region list file for box plot") 

    # ATAC: 6. IGV snapshot
    ATAC_igv_parser = ATAC_subparsers.add_parser('igv', help='ATAC IGV snapshot')
    ATAC_igv_parser.add_argument("-i","--input",required=True, type=str, help="The input list file")
    ATAC_igv_parser.add_argument("-o","--output",required=True,type=str, help="Output directory")
    ATAC_igv_parser.add_argument("--genome", required=True, type=str, help="Select the genome id")
    ATAC_igv_parser.add_argument("--display_mode",default='collapse',help="Display mode", choices=["collapse","expand","squish"])
    ATAC_igv_parser.add_argument("--region",required=True,help="Specify the regions, separate by ,")
    ATAC_igv_parser.add_argument("--type", default='png', type=str,choices=['svg','png'] ,help="svg or png output")

    # ATAC: 7. Similarity
    ATAC_correlation_parser = ATAC_subparsers.add_parser('similarity', help='ATAC sample similarity analysis')
    ATAC_correlation_parser.add_argument("--bw1",required=True,help='Path to the first bw file')
    ATAC_correlation_parser.add_argument("--bw2",required=True,help='Path to the second bw file')
    ATAC_correlation_parser.add_argument("-o","--output",required=True,help='Output directory')
    ATAC_correlation_parser.add_argument("-t","--thread",type=int,default=30,help='Number of threads')
    ATAC_correlation_parser.add_argument("--region",help='Optional BED file for specific regions') 

    # ChIPseq&CUTTag
    ChIPseq_CUTTag_parser = subparsers.add_parser('ChIPseqCUTTag', help='ChIPseq&CUTTag pipeline')
    ChIPseq_CUTTag_subparsers = ChIPseq_CUTTag_parser.add_subparsers(help='ChIPseq&CUTTag pipeline', title='ChIPseq&CUTTag pipeline', dest='ChIPseq_CUTTag_command')

    # ChIPseq&CUTTag: 1. Preprocess
    ChIPseq_CUTTag_preprocess_parser = ChIPseq_CUTTag_subparsers.add_parser('preprocess', help='ChIPseq&CUTTag preprocess command')
    ChIPseq_CUTTag_preprocess_parser.add_argument('-i','--input',required=True, help='Input fq information file')
    ChIPseq_CUTTag_preprocess_parser.add_argument('-o','--output',required=True, help='Output directory')
    ChIPseq_CUTTag_preprocess_parser.add_argument('-s','--species',required=True, help='Specify species',choices=list(config['data'].keys()))
    ChIPseq_CUTTag_preprocess_parser.add_argument('-t','--thread',type=int,default=8, help='Number of threads, default: 8')

    # ChIPseq_CUTTag: 2. QC
    ChIPseq_CUTTag_QC_parser = ChIPseq_CUTTag_subparsers.add_parser('QC', help='ChIPseq_CUTTag replicate QC')
    ChIPseq_CUTTag_QC_parser.add_argument("-i","--input",required=True, type=str, help="The input ChIPseq_CUTTag sample information file")
    ChIPseq_CUTTag_QC_parser.add_argument("-s","--species", required=True,type=str, help="Species",choices=list(config['data'].keys()))
    ChIPseq_CUTTag_QC_parser.add_argument("--bin", type=int,default=100000, help="Bin size for genomic binning, default: 100000")
    ChIPseq_CUTTag_QC_parser.add_argument("--step", type=int,default=1, help="Peak file partition step, default: 1")
    ChIPseq_CUTTag_QC_parser.add_argument("-o","--output",required=True,type=str, help="Output directory")
    ChIPseq_CUTTag_QC_parser.add_argument("-t","--thread", type=int,default=30, help="Threads to run, default: 30")
    ChIPseq_CUTTag_QC_parser.add_argument('--width',default=12,type=int, help='The plot width, default: 12')
    ChIPseq_CUTTag_QC_parser.add_argument('--height',default=8,type=int, help='If plot height, default:8')

    # ChIPseq&CUTTag: 3. Pattern
    ChIPseq_CUTTag_pattern_parser = ChIPseq_CUTTag_subparsers.add_parser('pattern', help='ChIPseq&CUTTag preprocess command')
    ChIPseq_CUTTag_pattern_parser.add_argument("-bw",required=True, type=str, help="The input bw files list file")
    ChIPseq_CUTTag_pattern_parser.add_argument("-bed",required=True, type=str, help="The bed genomic regions to be analyzed list file")
    ChIPseq_CUTTag_pattern_parser.add_argument("-o","--output",required=True,type=str, help="Output directory")
    ChIPseq_CUTTag_pattern_parser.add_argument("--mode",default='reference-point',help="Analysis mode, default: reference-point",choices=["reference-point","scale-regions"])
    ChIPseq_CUTTag_pattern_parser.add_argument("--height",help="Heatmap height, default: 10",type=int,default=10)
    ChIPseq_CUTTag_pattern_parser.add_argument("-a","--upstream",help="Length to extend upstream of the genomic region start site (bp), default: 2000",type=int,default=2000)
    ChIPseq_CUTTag_pattern_parser.add_argument("-b","--downstream",help="Length to extend downstream of the genomic region end site (bp), default: 2000",type=int,default=2000)
    ChIPseq_CUTTag_pattern_parser.add_argument("-l","--length",help="Scaled genomic region length (bp), default: 3000",type=int,default=3000)
    ChIPseq_CUTTag_pattern_parser.add_argument("-t","--thread",help="Number of processors, default: 10",type=int,default=10)
    ChIPseq_CUTTag_pattern_parser.add_argument("--region",help="The reference point for reference-point, default: center",default='center',choices=['TSS','TES','center'])

    # ChIPseq_CUTTag: 4. motif
    ChIPseq_CUTTag_motif_parser = ChIPseq_CUTTag_subparsers.add_parser('motif', help='ChIPseq_CUTTag motif analysis')
    ChIPseq_CUTTag_motif_subparser = ChIPseq_CUTTag_motif_parser.add_subparsers(dest='motif_mode', required=True, help="Choose to analyze or plot")
    # homer find
    ChIPseq_CUTTag_Find_homer_subparser = ChIPseq_CUTTag_motif_subparser.add_parser('homer', help='Perform homer motif finding analysis')
    ChIPseq_CUTTag_Find_homer_subparser.add_argument("-i","--input",required=True,type=str, help="The input gene/peak information file")
    ChIPseq_CUTTag_Find_homer_subparser.add_argument("-o","--output",required=True,  type=str, help="Output directory")
    ChIPseq_CUTTag_Find_homer_subparser.add_argument("-s","--species",required=True, help='Available gene in HOMER or provide the path to genome FASTA files for peak mode', type=str)
    ChIPseq_CUTTag_Find_homer_subparser.add_argument("--mode",required=True,type=str, help="Analysis mode: peak/gene",choices=['gene','peak'])
    ChIPseq_CUTTag_Find_homer_subparser.add_argument("-t","--thread",default=20,  type=int, help="Number of threads, default: 20")
    ChIPseq_CUTTag_Find_homer_subparser.add_argument("--start",default=-300,type=int, help="offset from TSS, default=-300")
    ChIPseq_CUTTag_Find_homer_subparser.add_argument("--end",default=50,type=int, help="offset from TSS, default=50")
    # meme find
    ChIPseq_CUTTag_Find_meme_subparser = ChIPseq_CUTTag_motif_subparser.add_parser('meme', help='Perform meme motif finding analysis')
    ChIPseq_CUTTag_Find_meme_subparser.add_argument("-i","--input",required=True,help="The fasta input information file")
    ChIPseq_CUTTag_Find_meme_subparser.add_argument("-o","--output",required=True,  type=str, help="Output directory")
    ChIPseq_CUTTag_Find_meme_subparser.add_argument("-t","--thread",default=10,  type=int, help="Number of threads, default: 10")
    ChIPseq_CUTTag_Find_meme_subparser.add_argument("--nmotifs",default=3,  type=int, help="Number of motifs to extract, default: 3")
    ChIPseq_CUTTag_Find_meme_subparser.add_argument("-db","--database",required=True,  type=str, help="Database file")
    # homer heatmap
    ChIPseq_CUTTag_homer_heatmap_subparser = ChIPseq_CUTTag_motif_subparser.add_parser('homer_heatmap', help='Plot the homer finding result heatmap')
    ChIPseq_CUTTag_homer_heatmap_subparser.add_argument("-i","--input",required=True, type=str, help="The homer results information csv file")
    ChIPseq_CUTTag_homer_heatmap_subparser.add_argument("-o","--output",required=True,type=str, help="The output directory")
    ChIPseq_CUTTag_homer_heatmap_subparser.add_argument("--motif",default='no',type=str, help="The specified motifs txt file")
    ChIPseq_CUTTag_homer_heatmap_subparser.add_argument("--width",default=10,type=float, help="The plot width, default: 10")
    ChIPseq_CUTTag_homer_heatmap_subparser.add_argument("--height",default=8,type=float, help="The plot height, default: 8")
    # enrich heatmap
    ChIPseq_CUTTag_enrich_heatmap_subparser = ChIPseq_CUTTag_motif_subparser.add_parser('enrich_heatmap', help='Perform the motif enriched heatmap')
    ChIPseq_CUTTag_enrich_heatmap_subparser.add_argument("--motif_bed",required=True, type=str, help="The motif bed file information csv file")
    ChIPseq_CUTTag_enrich_heatmap_subparser.add_argument("--bed",required=True, type=str, help="The input bed file information csv file")
    ChIPseq_CUTTag_enrich_heatmap_subparser.add_argument("-o","--output",required=True,type=str, help="The output directory")
    ChIPseq_CUTTag_enrich_heatmap_subparser.add_argument("-t","--thread",default=12,type=int, help="The number of threads")
    ChIPseq_CUTTag_enrich_heatmap_subparser.add_argument("-s","--species",required=True,type=str, help="Species")

    # ChIPseq_CUTTag: 5. Accessbility
    ChIPseq_CUTTag_accessbility_parser = ChIPseq_CUTTag_subparsers.add_parser('accessbility', help='ChIPseq_CUTTag accessbility analysis')
    ChIPseq_CUTTag_accessbility_parser.add_argument("--bw",required=True, help="The input bw txt file")
    ChIPseq_CUTTag_accessbility_parser.add_argument("-o","--output",required=True, help="Output directory")
    ChIPseq_CUTTag_accessbility_parser.add_argument("--mode", required=True, choices=["region", "gene"], help="Analysis mode: region/gene")
    ChIPseq_CUTTag_accessbility_parser.add_argument("-i","--input", required=True, help="Input gene region or gene list txt file")
    ChIPseq_CUTTag_accessbility_parser.add_argument("--species",help="Species",choices=list(config['data'].keys()))
    ChIPseq_CUTTag_accessbility_parser.add_argument("--method", choices=["sample", "region_list"], default="sample",help="Boxplot plotting method：sample/region list")
    ChIPseq_CUTTag_accessbility_parser.add_argument("--center",required=True, help="Average profile alignment：region mode:peak/position，gene mode:TSS/TTS/whole")
    ChIPseq_CUTTag_accessbility_parser.add_argument("--promoter_size", type=int, default=5000, help="Gene promoter region size, default: TSS upstream and downstream 5kb")
    ChIPseq_CUTTag_accessbility_parser.add_argument("--region_list",default='',help="Region list file for box plot") 

    # ChIPseq_CUTTag: 6. IGV snapshot
    ChIPseq_CUTTag_igv_parser = ChIPseq_CUTTag_subparsers.add_parser('igv', help='ChIPseq_CUTTag IGV snapshot')
    ChIPseq_CUTTag_igv_parser.add_argument("-i","--input",required=True, type=str, help="The input list file")
    ChIPseq_CUTTag_igv_parser.add_argument("-o","--output",required=True,type=str, help="Output directory")
    ChIPseq_CUTTag_igv_parser.add_argument("--genome", required=True, type=str, help="Select the genome id")
    ChIPseq_CUTTag_igv_parser.add_argument("--display_mode",default='collapse',help="Display mode", choices=["collapse","expand","squish"])
    ChIPseq_CUTTag_igv_parser.add_argument("--region",required=True,help="Specify the regions, separate by ,")
    ChIPseq_CUTTag_igv_parser.add_argument("--type", default='png', type=str,choices=['svg','png'] ,help="svg or png output")

    # ChIPseq_CUTTag: 7. Correlation
    ChIPseq_CUTTag_correlation_parser = ChIPseq_CUTTag_subparsers.add_parser('correlation', help='ChIPseq_CUTTag correlation analysis')
    ChIPseq_CUTTag_correlation_parser.add_argument("--bw1",required=True,help='Path to the first bw file')
    ChIPseq_CUTTag_correlation_parser.add_argument("--bw2",required=True,help='Path to the second bw file')
    ChIPseq_CUTTag_correlation_parser.add_argument("-o","--output",required=True,help='Output directory')
    ChIPseq_CUTTag_correlation_parser.add_argument("-t","--thread",type=int,default=30,help='Number of threads')
    ChIPseq_CUTTag_correlation_parser.add_argument("--region",help='Optional BED file for specific regions')

    # HiC
    HiC_parser = subparsers.add_parser('HiC', help='HiC pipeline')
    HiC_subparsers = HiC_parser.add_subparsers(help='HiC pipeline', title='HiC pipeline', dest='HiC_command')

    # HiC: 1. Preprocess
    HiC_preprocess_parser = HiC_subparsers.add_parser('preprocess', help='HiC preprocess pipeline')
    HiC_preprocess_parser.add_argument("-i","--input",required=True, type=str, help="Input fastq file information file")
    HiC_preprocess_parser.add_argument("-o","--output",required=True,type=str, help="Output directory")
    HiC_preprocess_parser.add_argument('-s','--species',required=True,type=str, help='Specify the species',choices=list(config['data'].keys()))
    # Optional
    HiC_preprocess_parser.add_argument('-t','--thread',type=int,default=10,help="Number of thread, default:10")
    HiC_preprocess_parser.add_argument('-f','--filter',action='store_true',help="Do stricter filtering, use parameters refering to Ruan's Lab")
    HiC_preprocess_parser.add_argument('-r','--resolution',type=str,default='10000,100000,1000000', help="Specify the resolutions, separate by comma, default: 10000,100000,1000000")

    # HiC: 2. Correlation
    HiC_correlation_parser = HiC_subparsers.add_parser('correlation', help='HiC sample correlation analysis')
    HiC_correlation_parser.add_argument('-i',"--input",type=str, required=True, help="The HiC input sample information file")
    HiC_correlation_parser.add_argument('-o','--output',type=str,required=True,help="Specify the output directory")
    # Optional parameters
    HiC_correlation_parser.add_argument('--chr',type=str,default='No',help="Specify the chromosome")
    HiC_correlation_parser.add_argument('--inter_chrom',action='store_true',help="Whether to include inter chrom signals")
    HiC_correlation_parser.add_argument('--width',type=float,default=8,help="The width of the plot, default:8")
    HiC_correlation_parser.add_argument('--height',type=float,default=6,help="The height of the plot, default:6")
    
    # HiC: 3. Matrix
    HiC_matrix_parser = HiC_subparsers.add_parser('matrix', help='HiC matrix balancing and format tranfer')
    HiC_matrix_parser.add_argument('--inputFormat', type=str, required=True, help="Input format", choices=['pairs','cool','mcool','juicerhic','fanchic','h5'])
    HiC_matrix_parser.add_argument('--outputFormat', type=str, required=True, help="Output format", choices=['cool','mcool','juicerhic','fanchic','h5'])
    HiC_matrix_parser.add_argument('-i','--input',type=str, required=True, help="Input file")
    HiC_matrix_parser.add_argument('-o','--output',type=str, required=True, help="Output directory")
    # Optional
    HiC_matrix_parser.add_argument('-t','--thread', type=int, default=10, help="Number of threads, default: 10")
    HiC_matrix_parser.add_argument('-r','--resolution', type=str, default='', help="Resolutions")
    HiC_matrix_parser.add_argument('-n','--norm', type=str, default='None', help="Norm method",choices=['KR','ICE','VC','VC-SQRT','None'])
    HiC_matrix_parser.add_argument('--oe',type=str, default='',help="The resolution of O/E matrix to get")
    HiC_matrix_parser.add_argument('--sparse',type=str, default='',help="The resolution of sparse matrix to get")
    HiC_matrix_parser.add_argument('-s','--species',default='',type=str, help='Specify the species',choices=list(config['data'].keys()))
  
    # HiC: 4. TAD
    HiC_tad_parser = HiC_subparsers.add_parser('TAD', help='HiC TAD analysis')
    # Required parameter
    HiC_tad_parser.add_argument('-i', '--input', type=str, required=True, help="The information file")
    HiC_tad_parser.add_argument('-o', '--output', type=str, required=True, help="The output directory")
    # Optional parameter
    HiC_tad_parser.add_argument('--insulation_window', type=int, default=1000000, help="Window sizes to calculate insulation score in base pairs, default: 1000000")
    HiC_tad_parser.add_argument('--directionality_window', type=int, default=1000000, help="Window sizes to calculate directionality index in base pairs, default: 1000000")
    HiC_tad_parser.add_argument('--expand', type=int, default=1000000, help="Window sizes of boundary expansion in base pairs to calulate insulation score and DI near/on boundary, default: 1000000")

    # HiC: 5. Compartment
    HiC_compartment_parser = HiC_subparsers.add_parser('compartment', help='HiC compartment analysis')
    # Required parameter
    HiC_compartment_parser.add_argument('-i', '--input', type=str, required=True, help="The information file")
    HiC_compartment_parser.add_argument('-r', '--resolution', type=int, required=True, help="Resolution to specify")
    HiC_compartment_parser.add_argument('-o', '--output', type=str, required=True, help="The output directory")
    # Optional parameter
    HiC_compartment_parser.add_argument('-t', '--thread', type=int, default=20, help="The number of threads, default: 20")
    HiC_compartment_parser.add_argument('--GC', type=str, default='no', help="The GC file to provide, default: no")
    HiC_compartment_parser.add_argument('-s', '--species', type=str, default='no', help="The species, need to specify if no GC file provided, default: no",choices=['no'] +list(config['data'].keys()))
    HiC_compartment_parser.add_argument('--width', type=float, default=10, help="Default: 10")
    HiC_compartment_parser.add_argument('--height', type=float, default=8, help="Default: 8")

    # HiC: 6. Loop
    HiC_loop_parser = HiC_subparsers.add_parser('loop', help='HiC loop calling')
    HiC_loop_parser.add_argument("-i","--input",required=True, type=str, help="FanC supported hic input file")
    HiC_loop_parser.add_argument("-o","--output", required=True,type=str, help="Output directory")
    # Optional
    HiC_loop_parser.add_argument('-t','--thread',type=int,default=10,help="Number of thread, default:10")

    # HiC: 7. Reconstruction
    HiC_reconstruction_parser = HiC_subparsers.add_parser('reconstruct', help='HiC 3D reconstuction')
    HiC_reconstruction_subparser = HiC_reconstruction_parser.add_subparsers(dest='reconstruct_mode', required=True, help="Choose the reconstruction method: flamingo/hickit")
    # FLAMINGO
    HiC_reconstruction_flamingo = HiC_reconstruction_subparser.add_parser('flamingo', help='FLAMINGO 3D reconstruction')
    HiC_reconstruction_flamingo.add_argument('-i','--input', required=True, help='The input hic file')
    HiC_reconstruction_flamingo.add_argument("-o","--output", required=True,type=str, help="Output directory")
    HiC_reconstruction_flamingo.add_argument('--chr',required=True, help='The chromosome')
    HiC_reconstruction_flamingo.add_argument('--domain_res',required=True, help='The domain resolution')
    HiC_reconstruction_flamingo.add_argument('--frag_res',required=True, help='The fragment resolution')
    HiC_reconstruction_flamingo.add_argument('--norm',default='NONE', help='The normalization method, default: NONE')
    HiC_reconstruction_flamingo.add_argument('-t','--thread',type=int,default=10,help="Number of thread, default: 10")
    # HiCkit
    HiC_reconstruction_hickit = HiC_reconstruction_subparser.add_parser('hickit', help='HiCkit 3D reconstruction')
    HiC_reconstruction_hickit.add_argument('--r1',required=True, help='The hic read1 fastq compression file')
    HiC_reconstruction_hickit.add_argument('--r2',required=True, help='The hic read2 fastq compression file')
    HiC_reconstruction_hickit.add_argument('--species',required=True,help='The species',choices=list(config['data'].keys()))
    HiC_reconstruction_hickit.add_argument("-o","--output", required=True,type=str, help="Output directory")
    HiC_reconstruction_hickit.add_argument("--prefix", type=str,default='result',help="Output prefix, default: result")
    HiC_reconstruction_hickit.add_argument('--vcf',default='',help='The SNP vcf compression file (optional)')
    HiC_reconstruction_hickit.add_argument('--mat',default='',help='The maternal sample (optional)')
    HiC_reconstruction_hickit.add_argument('--pat',default='',help='The paternal sample (optional)')
    HiC_reconstruction_hickit.add_argument('-t','--thread',type=int,default=20,help="Number of thread, default:20")

    # HiC: 8. pss
    HiC_pss_parser = HiC_subparsers.add_parser('pss', help='HiC distance contact analysis and pss plot')
    HiC_pss_parser.add_argument("-i","--input",required=True, type=str, help="Input sample information file")
    HiC_pss_parser.add_argument("-o", "--output",required=True,type=str, help="Output directory")
    # Optional
    HiC_pss_parser.add_argument('--bin',type=str,default='20',help="Bins divided between each order of magnitude, default: 20")
    HiC_pss_parser.add_argument('--curve_mean_min',type=str,default='1e-6', help="The lower bound of the mean of the curve, default: 1e-6")
    HiC_pss_parser.add_argument('--curve_bin_min',type=str,default='0',help="The lower bound of bin index of the curve, deafault: 0")
    HiC_pss_parser.add_argument('--curve_x_min',type=str,default='4',help="The minimal X-axis truncation value of the curve, default: 4")
    HiC_pss_parser.add_argument('--curve_x_max',type=str,default='8',help="The maximal X-axis truncation value of the curve, default: 8")
    HiC_pss_parser.add_argument('--expcurve_y_bias',type=str,default='-4',help="The Y-axis offset when plotting the difference from the expectation curve, default: -4")
    HiC_pss_parser.add_argument('--expcurve_x_min',type=str,default='5',help="The minimal X-axis drop value when plotting the difference from the expectation curve, default: 5")
    HiC_pss_parser.add_argument('--expcurve_x_max',type=str,default='8',help="The maximal X-axis drop value when plotting the difference from the expectation curve, default: 8")
    HiC_pss_parser.add_argument('--heatmap_x_min',type=str,default='4.8',help="The minimal X-axis truncation value of the heatmap, default: 4.8")
    HiC_pss_parser.add_argument('--heatmap_x_max',type=str,default='7.5',help="The maximal X-axis truncation value of the heatmap, default: 7.5")
    HiC_pss_parser.add_argument('--width',type=str,default='10',help="The width of the plot, default: 10")
    HiC_pss_parser.add_argument('--height',type=str,default='6',help="The height of the plot, default: 6") 
    
    # HiC: 9. Compare
    HiC_compare_parser = HiC_subparsers.add_parser('compare', help='HiC contact compare analysis')
    HiC_compare_parser.add_argument('--hic1', type=str, required=True, help="The first hic file")
    HiC_compare_parser.add_argument('--hic2', type=str, required=True, help="The second hic file")
    HiC_compare_parser.add_argument('-o','--output',type=str,required=True,help="Specify the output directory")
    HiC_compare_parser.add_argument('--chr',type=str,required=True,help="Specify the chromosome")
    HiC_compare_parser.add_argument('--A_min',type=float,default=None,help="The average expression to filter out interactions, default: None")

    return parser.parse_args()

def main():
    args = parse_arguments()
    
    if args.omics == 'tools':
        if args.tools_command == 'download':
            tools_download(args)
        elif args.tools_command == 'prepare':
            tools_prepare(args)
    elif args.omics == 'bulkRNA':
        if args.bulkRNA_command == 'preprocess':
            bulkRNA_preprocess(args)
        elif args.bulkRNA_command == 'correlation':
            bulkRNA_cor(args)
        elif args.bulkRNA_command == 'DEG':
            bulkRNA_DEG(args)
        elif args.bulkRNA_command == 'enrich':
            bulkRNA_enrich(args)
        elif args.bulkRNA_command == 'similarity':
            bulkRNA_Similarity(args)
        elif args.bulkRNA_command == 'cluster':
            bulkRNA_Clustering(args)
        elif args.bulkRNA_command == 'splice':
            bulkRNA_AlternativeSpliceDetection(args)
    elif args.omics == 'scRNA':
        if args.scRNA_command == 'preprocess':
            scRNA_preprocess(args)
        elif args.scRNA_command == 'cluster':
            scRNA_cluster(args)
        elif args.scRNA_command == 'annotation':
            scRNA_annotation(args)
        elif args.scRNA_command == 'marker':
            scRNA_marker(args)
        elif args.scRNA_command == 'trajectory':
            scRNA_trajectory(args)
        elif args.scRNA_command == 'similarity':
            scRNA_similarity(args)
        elif args.scRNA_command == 'interaction':
            scRNA_interaction(args)
        elif args.scRNA_command == 'integrate':
            scRNA_integrate(args)
    elif args.omics == 'ATAC':
        if args.ATAC_command == 'preprocess':
            ATAC_preprocess(args)
        elif args.ATAC_command == 'correlation':
            ATAC_cor(args)
        elif args.ATAC_command == 'dynamic':
            ATAC_dynamic(args)
        elif args.ATAC_command == 'motif':
            ATAC_motif(args)
        elif args.ATAC_command == 'accessbility':
            ATAC_accessbility(args)
        elif args.ATAC_command == 'similarity':
            ATAC_similarity(args)
        elif args.ATAC_command == 'igv':
            ATAC_igv(args)
    elif args.omics == 'ChIPseqCUTTag':
        if args.ChIPseq_CUTTag_command == 'preprocess':
            ChIPseq_CUTTag_preprocess(args)
        elif args.ChIPseq_CUTTag_command == 'correlation':
            ATAC_cor(args)
        elif args.ChIPseq_CUTTag_command == 'pattern':
            ChIPseq_CUTTag_pattern(args)
        elif args.ChIPseq_CUTTag_command == 'motif':
            ATAC_motif(args)
        elif args.ChIPseq_CUTTag_command == 'accessbility':
            ATAC_accessbility(args)
        elif args.ChIPseq_CUTTag_command == 'similarity':
            ATAC_similarity(args)
        elif args.ChIPseq_CUTTag_command == 'igv':
            ATAC_igv(args)
    elif args.omics == 'HiC':
        if args.HiC_command == 'preprocess':
            HiC_preprocess(args)
        if args.HiC_command == 'correlation':
            HiC_cor(args)
        elif args.HiC_command == 'matrix':
            HiC_matrix(args)
        elif args.HiC_command == 'TAD':
            HiC_tad(args)
        elif args.HiC_command == 'compartment':
            HiC_compartment(args)
        elif args.HiC_command == 'loop':
            HiC_loop(args)
        elif args.HiC_command == 'reconstruct':
            HiC_reconstruct(args)
        elif args.HiC_command == 'pss':
            HiC_pss(args)
        elif args.HiC_command == 'compare':
            HiC_compare(args)

if __name__ == "__main__":
    main()
